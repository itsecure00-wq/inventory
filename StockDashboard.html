<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root { --brand: #d32f2f; --green: #2e7d32; --orange: #f57c00; --blue: #1565c0; }
    body { background: #f5f5f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding-bottom: 90px; }

    .top-bar { background: var(--brand); color: white; padding: 16px 20px; position: sticky; top: 0; z-index: 100; }
    .top-bar h6 { margin: 0; font-weight: 700; }

    .stat-cards { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; padding: 16px; }
    .stat-card { background: white; border-radius: 12px; padding: 14px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .stat-num { font-size: 28px; font-weight: 700; line-height: 1.2; }
    .stat-label { font-size: 11px; color: #888; }

    .section-title { padding: 8px 20px; font-size: 14px; font-weight: 600; color: #666; background: #f0f0f0; border-bottom: 1px solid #e0e0e0; }

    .low-item { background: white; padding: 14px 20px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 12px; }
    .low-urgency { width: 6px; min-height: 40px; border-radius: 3px; flex-shrink: 0; }
    .urgency-critical { background: var(--brand); }
    .urgency-warning { background: var(--orange); }
    .low-info { flex: 1; }
    .low-name { font-weight: 600; font-size: 14px; }
    .low-detail { font-size: 12px; color: #888; }
    .low-action { text-align: right; min-width: 80px; }
    .low-need { font-size: 14px; font-weight: 600; color: var(--brand); }
    .low-cost { font-size: 11px; color: #888; }
    .low-supplier { font-size: 11px; color: var(--blue); }

    .high-item { background: white; padding: 12px 20px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; justify-content: space-between; }

    .check-progress { background: white; padding: 16px 20px; margin: 10px 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .progress { height: 8px; border-radius: 4px; }

    .summary-box { background: white; margin: 10px 16px; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }

    .cat-stats { background: white; margin: 10px 16px; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .cat-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #f5f5f5; font-size: 13px; }
    .cat-row:last-child { border-bottom: none; }
    .cat-row .cat-name { font-weight: 500; }
    .cat-row .cat-low { color: var(--brand); font-weight: 600; font-size: 12px; }

    .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 12px 16px; box-shadow: 0 -4px 12px rgba(0,0,0,0.08); z-index: 100; display: flex; gap: 10px; }
    .btn-po { flex: 1; border: none; border-radius: 12px; padding: 12px; font-size: 14px; font-weight: 600; color: white; }
    .btn-po.primary { background: var(--brand); }
    .btn-po.whatsapp { background: #25d366; }

    .loading { text-align: center; padding: 60px 20px; color: #999; }
    .loading .spinner-border { color: var(--brand); width: 40px; height: 40px; }

    .nav-btn {
      display: inline-flex; align-items: center; gap: 4px;
      background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.25);
      border-radius: 8px; color: white; font-size: 13px; font-weight: 500;
      padding: 8px 12px; min-height: 44px; min-width: 44px;
      justify-content: center; text-decoration: none; cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .nav-btn:active { background: rgba(255,255,255,0.3); }
    .nav-btn i { font-size: 16px; }
    .empty-state { text-align: center; padding: 30px; color: #999; font-size: 14px; }

    .all-stock-cat {
      background: #f8f8f8; padding: 10px 20px; font-size: 13px; font-weight: 600;
      color: #666; border-bottom: 1px solid #eee; cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
    }
    .all-stock-item { background: white; padding: 10px 20px; border-bottom: 1px solid #f5f5f5; display: flex; align-items: center; gap: 8px; font-size: 13px; }
    .stock-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .stock-dot.low { background: var(--brand); }
    .stock-dot.high { background: var(--orange); }
    .stock-dot.ok { background: var(--green); }
    .all-stock-name { flex: 1; font-weight: 500; }
    .all-stock-qty { text-align: right; min-width: 70px; }
    .all-stock-qty .qty-num { font-weight: 600; font-size: 14px; }
    .all-stock-qty .qty-range { font-size: 11px; color: #aaa; }

    @media (max-width: 360px) {
      .stat-cards { gap: 6px; padding: 10px; }
      .stat-num { font-size: 22px; }
      .btn-po { font-size: 12px; padding: 10px; }
      .nav-btn { padding: 6px 8px; font-size: 12px; }
    }
  </style>
</head>
<body>

<div class="top-bar">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h6>ğŸ² å¼ é‡è¾‰ç«é”… Â· ç™¾ä¸‡é•‡ è´§å“çœ‹æ¿</h6>
      <small id="dateInfo"></small>
    </div>
    <div style="display:flex;gap:6px;align-items:center">
      <button class="nav-btn" onclick="goCheck()"><i class="bi bi-clipboard-check"></i> ç›˜ç‚¹</button>
      <button class="nav-btn" onclick="loadAll()"><i class="bi bi-arrow-clockwise"></i> åˆ·æ–°</button>
      <button class="nav-btn" onclick="logout()"><i class="bi bi-box-arrow-right"></i> ç™»å‡º</button>
    </div>
  </div>
</div>

<div class="loading" id="loadingDiv">
  <div class="spinner-border mb-3"></div>
  <div>åŠ è½½çœ‹æ¿æ•°æ®...</div>
</div>

<div id="contentDiv" style="display:none">
  <div class="stat-cards">
    <div class="stat-card">
      <div class="stat-num" style="color:var(--brand)" id="lowNum">0</div>
      <div class="stat-label">ğŸ”´ éœ€è¡¥è´§</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:var(--orange)" id="highNum">0</div>
      <div class="stat-label">ğŸŸ¡ åé«˜</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:var(--green)" id="normalNum">0</div>
      <div class="stat-label">ğŸŸ¢ æ­£å¸¸</div>
    </div>
  </div>

  <div class="check-progress">
    <div class="d-flex justify-content-between mb-1">
      <span style="font-size:13px;font-weight:600">ğŸ“‹ ä»Šæ—¥ç›˜ç‚¹</span>
      <span style="font-size:13px" id="checkText">0/0</span>
    </div>
    <div class="progress">
      <div class="progress-bar" id="checkBar" style="width:0%;background:var(--brand)"></div>
    </div>
    <div style="font-size:11px;color:#999;margin-top:4px" id="checkStaff"></div>
  </div>

  <div class="summary-box">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <div style="font-size:13px;color:#888">ğŸ“¦ åº“å­˜æ€»å€¼</div>
        <div style="font-size:20px;font-weight:700;color:var(--blue)" id="totalValue">RM 0</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:13px;color:#888">æ€»ç‰©å“</div>
        <div style="font-size:18px;font-weight:600" id="totalItems">0</div>
      </div>
    </div>
  </div>

  <div class="section-title" id="lowTitle">ğŸ”´ éœ€è¡¥è´§ (0é¡¹)</div>
  <div id="lowList"></div>

  <div class="section-title" id="highTitle" style="display:none">ğŸŸ¡ åº“å­˜åé«˜ (0é¡¹)</div>
  <div id="highList"></div>

  <div class="section-title" id="catTitle" style="display:none">ğŸ“Š åˆ†ç±»ç»Ÿè®¡</div>
  <div class="cat-stats" id="catStats" style="display:none"></div>

  <div class="section-title" id="allStockTitle" style="display:none">ğŸ“¦ å…¨éƒ¨åº“å­˜</div>
  <div id="allStockList"></div>

  <div class="summary-box" id="summaryBox" style="display:none">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <div style="font-size:13px;color:#888">ğŸ’° è¡¥è´§é¢„ä¼°æ€»é¢</div>
        <div style="font-size:24px;font-weight:700;color:var(--brand)" id="totalCost">RM 0</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:13px;color:#888">å¾…é‡‡è´­å•</div>
        <div style="font-size:18px;font-weight:600" id="pendingPO">0</div>
      </div>
    </div>
  </div>
</div>

<div class="bottom-bar" id="bottomBar" style="display:none">
  <button class="btn-po primary" onclick="generatePO()">
    <i class="bi bi-clipboard-check"></i> ç”Ÿæˆé‡‡è´­å•
  </button>
  <button class="btn-po whatsapp" onclick="sendWhatsApp()">
    <i class="bi bi-whatsapp"></i> å‘é€é‡‡è´­å•
  </button>
</div>

<script>
  // Safe localStorage wrapper (GAS sandbox blocks cross-origin access)
  function lsGet(key) { try { return localStorage.getItem(key); } catch(e) { return null; } }
  function lsSet(key, val) { try { localStorage.setItem(key, val); } catch(e) {} }
  function lsDel(key) { try { localStorage.removeItem(key); } catch(e) {} }

  var dashboardData = null;
  var lowItems = [];
  var highItems = [];
  var allStockItems = [];
  var CATEGORY_ICONS = {
    'è‚‰ç±»': 'ğŸ¥©', 'èœç±»': 'ğŸ¥¬', 'æµ·é²œ': 'ğŸ¦', 'ä¸¸å­': 'ğŸœ',
    'é”…åº•': 'ğŸ«•', 'è°ƒå‘³æ–™': 'ğŸ§‚', 'é…’æ°´': 'ğŸº', 'æ¶ˆè€—å“': 'ğŸ§»',
    'ç”œå“': 'ğŸ°', 'é¥®å“ç±»': 'ğŸ§ƒ'
  };

  window.onload = function() {
    var saved = lsGet('ims_user');
    if (!saved) {
      document.body.innerHTML = '<div style="text-align:center;padding:60px 20px;color:#999">' +
        '<div style="font-size:36px;margin-bottom:12px">ğŸ”’</div>' +
        '<div style="font-size:15px">æœªæ£€æµ‹åˆ°ç™»å½•ä¿¡æ¯ï¼Œæ­£åœ¨è·³è½¬ç™»å½•...</div></div>';
      setTimeout(function() { goLogin(); }, 1500);
      return;
    }
    try {
      var user = JSON.parse(saved);
      if (user.role === 'Staff') { goCheck(); return; }
    } catch(e) { goLogin(); return; }

    document.getElementById('dateInfo').textContent = new Date().toLocaleDateString('zh-CN', {
      year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
    });
    loadAll();
  };

  function goLogin() {
    lsDel('ims_user');
    window.top.location.href = window.top.location.href.split('?')[0] + '?page=login';
  }
  function goCheck() {
    window.top.location.href = window.top.location.href.split('?')[0] + '?page=check';
  }
  function logout() { goLogin(); }

  function showLoadError(msg) {
    document.getElementById('loadingDiv').style.display = 'block';
    document.getElementById('contentDiv').style.display = 'none';
    document.getElementById('loadingDiv').innerHTML =
      '<div style="color:var(--brand)">âŒ ' + msg + '</div>' +
      '<button class="btn btn-sm btn-outline-danger mt-3" onclick="loadAll()">é‡è¯•</button>';
  }

  function loadAll() {
    document.getElementById('loadingDiv').style.display = 'block';
    document.getElementById('loadingDiv').innerHTML =
      '<div class="spinner-border mb-3"></div><div>åŠ è½½çœ‹æ¿æ•°æ®...</div>';
    document.getElementById('contentDiv').style.display = 'none';

    // Sequential: getStockDashboard -> getLowStockItems -> getHighStockItems -> getItemsByCategory
    google.script.run
      .withSuccessHandler(function(r1) {
        dashboardData = r1;
        google.script.run
          .withSuccessHandler(function(r2) {
            lowItems = r2.success ? r2.items : [];
            google.script.run
              .withSuccessHandler(function(r3) {
                highItems = r3.success ? r3.items : [];
                google.script.run
                  .withSuccessHandler(function(r4) {
                    allStockItems = r4.success ? r4.items : [];
                    renderDashboard();
                  })
                  .withFailureHandler(function() { allStockItems = []; renderDashboard(); })
                  .getItemsByCategory('');
              })
              .withFailureHandler(function() {
                highItems = [];
                google.script.run
                  .withSuccessHandler(function(r4) { allStockItems = r4.success ? r4.items : []; renderDashboard(); })
                  .withFailureHandler(function() { allStockItems = []; renderDashboard(); })
                  .getItemsByCategory('');
              })
              .getHighStockItems();
          })
          .withFailureHandler(function(err) {
            lowItems = [];
            showLoadError('è·å–ä½åº“å­˜å¤±è´¥: ' + (err.message || err));
          })
          .getLowStockItems();
      })
      .withFailureHandler(function(err) {
        showLoadError('è·å–çœ‹æ¿å¤±è´¥: ' + (err.message || err));
      })
      .getStockDashboard();
  }

  function renderDashboard() {
    document.getElementById('loadingDiv').style.display = 'none';
    document.getElementById('contentDiv').style.display = 'block';

    if (!dashboardData || !dashboardData.success) {
      showLoadError('çœ‹æ¿æ•°æ®æ— æ•ˆ');
      return;
    }
    var d = dashboardData;

    document.getElementById('lowNum').textContent = d.lowCount;
    document.getElementById('highNum').textContent = d.highCount;
    document.getElementById('normalNum').textContent = d.normalCount;

    document.getElementById('checkText').textContent = d.todayChecked + '/' + d.todayTotal;
    document.getElementById('checkBar').style.width = d.checkProgress + '%';
    document.getElementById('checkBar').style.background = d.checkProgress >= 100 ? 'var(--green)' : 'var(--brand)';
    document.getElementById('checkStaff').textContent =
      d.checkProgress >= 100 ? 'âœ… ä»Šæ—¥ç›˜ç‚¹å·²å®Œæˆ' :
      d.todayTotal === 0 ? 'ä»Šæ—¥æ— éœ€ç›˜ç‚¹' :
      'å¾…ç›˜ç‚¹ ' + (d.todayTotal - d.todayChecked) + ' é¡¹';

    document.getElementById('totalValue').textContent = 'RM ' + (d.totalValue || 0).toFixed(2);
    document.getElementById('totalItems').textContent = d.total;

    if (d.categoryStats) {
      var cats = Object.keys(d.categoryStats).sort(function(a, b) { return d.categoryStats[b].low - d.categoryStats[a].low; });
      var catHtml = '';
      for (var c = 0; c < cats.length; c++) {
        var cs = d.categoryStats[cats[c]];
        catHtml += '<div class="cat-row"><span class="cat-name">' + cats[c] + ' <span style="color:#bbb;font-size:11px">(' + cs.total + 'é¡¹)</span></span>';
        catHtml += cs.low > 0 ? '<span class="cat-low">ğŸ”´ ç¼º ' + cs.low + ' é¡¹</span>' : '<span style="color:var(--green);font-size:12px">âœ… å……è¶³</span>';
        catHtml += '</div>';
      }
      document.getElementById('catStats').innerHTML = catHtml;
      document.getElementById('catStats').style.display = 'block';
      document.getElementById('catTitle').style.display = 'block';
    }

    document.getElementById('lowTitle').textContent = 'ğŸ”´ éœ€è¡¥è´§ (' + lowItems.length + 'é¡¹)';
    var lowHtml = '';
    if (lowItems.length === 0) {
      lowHtml = '<div class="empty-state">âœ… æ‰€æœ‰ç‰©å“åº“å­˜å……è¶³</div>';
    } else {
      var totalCost = 0;
      for (var i = 0; i < lowItems.length; i++) {
        var item = lowItems[i];
        totalCost += item.totalCost || 0;
        var urg = (item.urgency || 100) < 30 ? 'urgency-critical' : 'urgency-warning';
        lowHtml += '<div class="low-item">';
        lowHtml += '<div class="low-urgency ' + urg + '"></div>';
        lowHtml += '<div class="low-info"><div class="low-name">' + item.name + '</div>';
        lowHtml += '<div class="low-detail">å½“å‰ ' + item.currentQty + item.unit + ' / æœ€ä½ ' + item.minStock + item.unit + '</div>';
        if (item.supplier) lowHtml += '<div class="low-supplier">ğŸ“¦ ' + item.supplier + '</div>';
        lowHtml += '</div><div class="low-action"><div class="low-need">+' + item.need + item.unit + '</div>';
        lowHtml += item.price > 0 ? '<div class="low-cost">â‰ˆ RM ' + (item.totalCost || 0).toFixed(2) + '</div>' : '<div class="low-cost" style="color:var(--orange)">æœªè®¾ä»·</div>';
        lowHtml += '</div></div>';
      }
      document.getElementById('summaryBox').style.display = 'block';
      document.getElementById('totalCost').textContent = 'RM ' + totalCost.toFixed(2);
      document.getElementById('pendingPO').textContent = d.pendingPO || 0;
      document.getElementById('bottomBar').style.display = 'flex';
    }
    document.getElementById('lowList').innerHTML = lowHtml;

    if (highItems.length > 0) {
      document.getElementById('highTitle').style.display = 'block';
      document.getElementById('highTitle').textContent = 'ğŸŸ¡ åº“å­˜åé«˜ (' + highItems.length + 'é¡¹)';
      var highHtml = '';
      for (var j = 0; j < highItems.length; j++) {
        var h = highItems[j];
        highHtml += '<div class="high-item">';
        highHtml += '<div><strong>' + h.name + '</strong> <span style="color:#888;font-size:12px">' + h.category + '</span></div>';
        highHtml += '<div style="color:var(--orange);font-weight:600">' + h.currentQty + '/' + h.maxStock + h.unit + ' (+' + h.excess + ')</div>';
        highHtml += '</div>';
      }
      document.getElementById('highList').innerHTML = highHtml;
    }

    if (allStockItems.length > 0) {
      document.getElementById('allStockTitle').style.display = 'block';
      document.getElementById('allStockTitle').textContent = 'ğŸ“¦ å…¨éƒ¨åº“å­˜ (' + allStockItems.length + 'é¡¹)';

      var catGroups = {}, catOrder = [];
      for (var a = 0; a < allStockItems.length; a++) {
        var ai = allStockItems[a];
        var cat = ai.category || 'æœªåˆ†ç±»';
        if (!catGroups[cat]) { catGroups[cat] = []; catOrder.push(cat); }
        catGroups[cat].push(ai);
      }

      var allHtml = '';
      for (var ci = 0; ci < catOrder.length; ci++) {
        var cn = catOrder[ci];
        var cItems = catGroups[cn];
        var cIcon = CATEGORY_ICONS[cn] || 'ğŸ“¦';
        var cId = 'allCat_' + ci;
        var cLow = 0, cHigh = 0;
        for (var si = 0; si < cItems.length; si++) {
          if (cItems[si].currentQty < cItems[si].minStock && cItems[si].minStock > 0) cLow++;
          else if (cItems[si].currentQty > cItems[si].maxStock && cItems[si].maxStock > 0) cHigh++;
        }
        var cStatus = (cLow > 0 ? '<span style="color:var(--brand)">ğŸ”´' + cLow + '</span> ' : '') +
                      (cHigh > 0 ? '<span style="color:var(--orange)">ğŸŸ¡' + cHigh + '</span> ' : '') +
                      '<span style="color:var(--green)">ğŸŸ¢' + (cItems.length - cLow - cHigh) + '</span>';

        allHtml += '<div class="all-stock-cat" onclick="toggleCatAll(\'' + cId + '\',this)">';
        allHtml += '<span>' + cIcon + ' ' + cn + ' (' + cItems.length + ')</span>';
        allHtml += '<span>' + cStatus + ' <i class="bi bi-chevron-right"></i></span></div>';
        allHtml += '<div id="' + cId + '" style="display:none">';

        for (var ii = 0; ii < cItems.length; ii++) {
          var si2 = cItems[ii];
          var dotClass = (si2.currentQty < si2.minStock && si2.minStock > 0) ? 'low' :
                         (si2.currentQty > si2.maxStock && si2.maxStock > 0) ? 'high' : 'ok';
          allHtml += '<div class="all-stock-item"><div class="stock-dot ' + dotClass + '"></div>';
          allHtml += '<div class="all-stock-name">' + si2.name + '</div>';
          allHtml += '<div class="all-stock-qty"><div class="qty-num">' + si2.currentQty + ' ' + si2.unit + '</div>';
          allHtml += '<div class="qty-range">' + si2.minStock + '~' + si2.maxStock + '</div></div></div>';
        }
        allHtml += '</div>';
      }
      document.getElementById('allStockList').innerHTML = allHtml;
    }
  }

  function generatePO() {
    if (!confirm('ç¡®è®¤ç”Ÿæˆé‡‡è´­å•ï¼Ÿå°†åŒ…å« ' + lowItems.length + ' é¡¹ä½åº“å­˜ç‰©å“')) return;
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          alert(result.itemCount > 0 ?
            'âœ… é‡‡è´­å•å·²ç”Ÿæˆ\n\nå•å·: ' + result.poId + '\nç‰©å“: ' + result.itemCount + 'é¡¹\næ€»é¢: RM ' + result.totalCost :
            'âœ… å½“å‰æ— éœ€è¡¥è´§');
          loadAll();
        } else {
          alert('âŒ ç”Ÿæˆå¤±è´¥: ' + result.error);
        }
      })
      .withFailureHandler(function(err) { alert('âŒ é”™è¯¯: ' + (err.message || err)); })
      .generatePurchaseOrder();
  }

  function sendWhatsApp() {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          window.open('https://wa.me/?text=' + encodeURIComponent(result.text), '_blank');
        } else {
          alert('è·å–é‡‡è´­å•å¤±è´¥: ' + (result.error || ''));
        }
      })
      .withFailureHandler(function(err) { alert('è·å–é‡‡è´­å•å¤±è´¥: ' + (err.message || err)); })
      .getPurchaseOrderText();
  }

  function toggleCatAll(catId, header) {
    var el = document.getElementById(catId);
    if (!el) return;
    var icon = header.querySelector('.bi');
    if (el.style.display === 'none') {
      el.style.display = 'block';
      if (icon) icon.className = 'bi bi-chevron-down';
    } else {
      el.style.display = 'none';
      if (icon) icon.className = 'bi bi-chevron-right';
    }
  }
</script>

</body>
</html>
