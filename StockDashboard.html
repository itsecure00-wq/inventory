<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>è´§å“çœ‹æ¿</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Helvetica Neue', sans-serif;
      background: #f5f5f5; color: #212121;
      padding-bottom: 100px;
    }

    /* â”€â”€ é¡¶æ  â”€â”€ */
    .topbar {
      position: sticky; top: 0; z-index: 100;
      background: #d32f2f; color: #fff;
      padding: 12px 14px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 2px 6px rgba(0,0,0,.25);
    }
    .topbar-title { font-size: 15px; font-weight: 700; }
    .topbar-sub   { font-size: 11px; opacity: .82; margin-top: 2px; }
    .topbar-btns  { display: flex; gap: 6px; align-items: center; }
    .nav-btn {
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.35);
      color: #fff; padding: 6px 10px;
      border-radius: 7px; font-size: 12px; font-weight: 500;
      cursor: pointer; white-space: nowrap;
    }
    .nav-btn.admin-btn { background: rgba(255,255,255,.3); font-weight: 700; }

    /* â”€â”€ åŠ è½½ â”€â”€ */
    .loading-area {
      text-align: center; padding: 60px 24px; color: #9e9e9e;
    }
    .spinner {
      width: 36px; height: 36px; margin: 0 auto 16px;
      border: 3px solid #ffcdd2; border-top-color: #d32f2f;
      border-radius: 50%; animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ ç»Ÿè®¡å¡ç‰‡ â”€â”€ */
    .stat-grid {
      display: grid; grid-template-columns: 1fr 1fr 1fr;
      gap: 10px; padding: 14px;
    }
    .stat-card {
      background: #fff; border-radius: 12px;
      padding: 14px; text-align: center;
      box-shadow: 0 1px 4px rgba(0,0,0,.07);
    }
    .stat-num   { font-size: 26px; font-weight: 700; line-height: 1.1; }
    .stat-label { font-size: 11px; color: #9e9e9e; margin-top: 4px; }

    /* â”€â”€ ä»Šæ—¥ç›˜ç‚¹è¿›åº¦ â”€â”€ */
    .progress-card {
      background: #fff; margin: 0 14px 10px;
      border-radius: 12px; padding: 14px;
      box-shadow: 0 1px 4px rgba(0,0,0,.07);
    }
    .progress-row {
      display: flex; justify-content: space-between;
      font-size: 13px; font-weight: 600; margin-bottom: 8px;
    }
    .progress-track {
      height: 8px; background: #ffcdd2; border-radius: 4px; overflow: hidden;
    }
    .progress-fill {
      height: 100%; background: #d32f2f; border-radius: 4px;
      transition: width .5s ease;
    }
    .progress-fill.done { background: #388e3c; }
    .progress-note { font-size: 11px; color: #9e9e9e; margin-top: 5px; }

    /* â”€â”€ åŒºå—æ ‡é¢˜ â”€â”€ */
    .section-title {
      padding: 8px 16px; font-size: 13px; font-weight: 600;
      color: #616161; background: #eeeeee;
      border-top: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0;
      margin-top: 6px;
    }

    /* â”€â”€ ä½/é«˜åº“å­˜åˆ—è¡¨ â”€â”€ */
    .stock-item {
      background: #fff; padding: 12px 16px;
      border-bottom: 1px solid #f5f5f5;
      display: flex; align-items: center; gap: 12px;
    }
    .urgency-bar { width: 5px; min-height: 40px; border-radius: 3px; flex-shrink: 0; }
    .urg-critical { background: #d32f2f; }
    .urg-warning  { background: #ff9800; }
    .urg-high     { background: #ff6f00; }
    .si-info { flex: 1; min-width: 0; }
    .si-name { font-size: 14px; font-weight: 600; }
    .si-detail { font-size: 11px; color: #9e9e9e; margin-top: 2px; }
    .si-supplier { font-size: 11px; color: #1565c0; }
    .si-right { text-align: right; flex-shrink: 0; }
    .si-need { font-size: 14px; font-weight: 700; color: #d32f2f; }
    .si-cost { font-size: 11px; color: #9e9e9e; }
    .si-excess { font-size: 14px; font-weight: 700; color: #ff6f00; }

    /* â”€â”€ æ€»å€¼å¡ â”€â”€ */
    .value-card {
      background: #fff; margin: 6px 14px;
      border-radius: 12px; padding: 14px;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 1px 4px rgba(0,0,0,.07);
    }
    .vc-left .vc-sub { font-size: 12px; color: #9e9e9e; }
    .vc-left .vc-num { font-size: 22px; font-weight: 700; color: #1565c0; }
    .vc-right { text-align: right; }
    .vc-right .vc-sub { font-size: 12px; color: #9e9e9e; }
    .vc-right .vc-num { font-size: 18px; font-weight: 600; }

    /* â”€â”€ å…¨éƒ¨åº“å­˜æŠ˜å  â”€â”€ */
    .cat-header {
      background: #f8f8f8; padding: 10px 16px;
      font-size: 13px; font-weight: 600; color: #555;
      border-bottom: 1px solid #eee;
      cursor: pointer; user-select: none;
      display: flex; justify-content: space-between; align-items: center;
    }
    .cat-body { display: none; }
    .cat-body.open { display: block; }
    .all-item {
      background: #fff; padding: 10px 16px;
      border-bottom: 1px solid #f5f5f5;
      display: flex; align-items: center; gap: 8px; font-size: 13px;
    }
    .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .dot-low  { background: #d32f2f; }
    .dot-high { background: #ff9800; }
    .dot-ok   { background: #388e3c; }
    .ai-name { flex: 1; font-weight: 500; }
    .ai-qty  { text-align: right; min-width: 70px; }
    .ai-qty .qn { font-weight: 700; font-size: 14px; }
    .ai-qty .qr { font-size: 11px; color: #bbb; }

    /* â”€â”€ ç›˜ç‚¹å†å² â”€â”€ */
    .hist-row {
      background: #fff; padding: 11px 16px;
      border-bottom: 1px solid #f5f5f5;
      display: flex; align-items: center; justify-content: space-between;
    }
    .hist-date { font-size: 13px; font-weight: 600; }
    .hist-meta { font-size: 11px; color: #9e9e9e; margin-top: 2px; }
    .hist-badge {
      display: inline-block; padding: 2px 8px;
      border-radius: 10px; font-size: 11px; font-weight: 600;
      margin-left: 6px;
    }
    .badge-abnormal { background: #fbe9e7; color: #d32f2f; }
    .badge-ok       { background: #e8f5e9; color: #388e3c; }

    /* â”€â”€ åº•éƒ¨æ“ä½œæ  â”€â”€ */
    .bottom-bar {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
      background: #fff; padding: 10px 14px 14px;
      box-shadow: 0 -2px 10px rgba(0,0,0,.12);
      display: flex; gap: 8px;
    }
    .action-btn {
      flex: 1; padding: 12px; border: none; border-radius: 10px;
      font-size: 14px; font-weight: 600; cursor: pointer;
    }
    .btn-po       { background: #d32f2f; color: #fff; }
    .btn-wa       { background: #25d366; color: #fff; }

    /* â”€â”€ ç©ºçŠ¶æ€ â”€â”€ */
    .empty-state {
      text-align: center; padding: 28px; color: #9e9e9e; font-size: 13px;
    }

    @media (max-width: 360px) {
      .stat-grid { gap: 6px; padding: 10px; }
      .stat-num  { font-size: 22px; }
    }
  </style>
</head>
<body>

<!-- é¡¶æ  -->
<div class="topbar">
  <div>
    <div class="topbar-title">ğŸ² ç™¾ä¸‡é•‡ Â· è´§å“çœ‹æ¿</div>
    <div class="topbar-sub" id="dateInfo"></div>
  </div>
  <div class="topbar-btns">
    <button id="adminBtn" class="nav-btn admin-btn" style="display:none" onclick="navigateTo('admin')">âš™ï¸ ç®¡ç†</button>
    <button class="nav-btn" onclick="navigateTo('check')">ğŸ“‹ ç›˜ç‚¹</button>
    <button class="nav-btn" onclick="loadAll()">ğŸ”„ åˆ·æ–°</button>
    <button class="nav-btn" onclick="doLogout()">é€€å‡º</button>
  </div>
</div>

<!-- åŠ è½½åŒº -->
<div class="loading-area" id="loadingArea">
  <div class="spinner"></div>
  <div>åŠ è½½çœ‹æ¿æ•°æ®...</div>
</div>

<!-- ä¸»å†…å®¹ -->
<div id="mainContent" style="display:none">

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <div class="stat-grid">
    <div class="stat-card">
      <div class="stat-num" style="color:#d32f2f" id="statLow">0</div>
      <div class="stat-label">ğŸ”´ éœ€è¡¥è´§</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:#ff9800" id="statHigh">0</div>
      <div class="stat-label">ğŸŸ¡ åé«˜</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:#388e3c" id="statNormal">0</div>
      <div class="stat-label">ğŸŸ¢ æ­£å¸¸</div>
    </div>
  </div>

  <!-- ä»Šæ—¥ç›˜ç‚¹è¿›åº¦ -->
  <div class="progress-card">
    <div class="progress-row">
      <span>ğŸ“‹ ä»Šæ—¥ç›˜ç‚¹</span>
      <span id="checkText">0/0</span>
    </div>
    <div class="progress-track">
      <div class="progress-fill" id="checkFill" style="width:0%"></div>
    </div>
    <div class="progress-note" id="checkNote"></div>
  </div>

  <!-- åº“å­˜æ€»å€¼ -->
  <div class="value-card">
    <div class="vc-left">
      <div class="vc-sub">ğŸ“¦ åº“å­˜æ€»å€¼</div>
      <div class="vc-num" id="totalValue">RM 0</div>
    </div>
    <div class="vc-right">
      <div class="vc-sub">æ€»ç‰©å“</div>
      <div class="vc-num" id="totalItems">0</div>
    </div>
  </div>

  <!-- éœ€è¡¥è´§ -->
  <div class="section-title" id="lowTitle">ğŸ”´ éœ€è¡¥è´§ (0é¡¹)</div>
  <div id="lowList"></div>

  <!-- åº“å­˜åé«˜ -->
  <div class="section-title" id="highTitle" style="display:none">ğŸŸ¡ åº“å­˜åé«˜ (0é¡¹)</div>
  <div id="highList"></div>

  <!-- å…¨éƒ¨åº“å­˜ -->
  <div class="section-title" id="allTitle">ğŸ“¦ å…¨éƒ¨åº“å­˜ (0é¡¹)</div>
  <div id="allList"></div>

  <!-- ç›˜ç‚¹å†å² -->
  <div class="section-title">ğŸ“… æœ€è¿‘7å¤©ç›˜ç‚¹è®°å½•</div>
  <div id="histList"></div>

  <!-- è¡¥è´§æ€»é¢ -->
  <div class="value-card" id="costCard" style="display:none">
    <div class="vc-left">
      <div class="vc-sub">ğŸ’° è¡¥è´§é¢„ä¼°æ€»é¢</div>
      <div class="vc-num" style="color:#d32f2f" id="totalCost">RM 0</div>
    </div>
    <div class="vc-right">
      <div class="vc-sub">å¾…é‡‡è´­å•</div>
      <div class="vc-num" id="pendingPO">0</div>
    </div>
  </div>
</div>

<!-- åº•éƒ¨æ“ä½œ -->
<div class="bottom-bar" id="bottomBar" style="display:none">
  <button class="action-btn btn-po" onclick="generatePO()">ğŸ“‹ ç”Ÿæˆé‡‡è´­å•</button>
  <button class="action-btn btn-wa" onclick="sendWhatsApp()">ğŸ“± WhatsAppå‘é€</button>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Storage è¾…åŠ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function lsGet(k)  { try { return localStorage.getItem(k);  } catch(e){ return null; } }
function lsDel(k)  { try { localStorage.removeItem(k);      } catch(e){} }
function ssGet(k)  { try { return sessionStorage.getItem(k); } catch(e){ return null; } }

// â”€â”€ é¡µé¢æƒé™è¾…åŠ© â”€â”€
var ROLE_DEFAULT_PERMS = {
  'Boss':    { pages: ['check','dashboard','admin'], adminTabs: [0,1,2,3,4] },
  'Manager': { pages: ['dashboard','admin'],         adminTabs: [0,1,2,3]   },
  'Staff':   { pages: ['check'],                     adminTabs: []           }
};
function parsePermissions(permStr, role) {
  try { var p = JSON.parse(permStr); if (p && Array.isArray(p.pages)) return p; } catch(e) {}
  return ROLE_DEFAULT_PERMS[role] || { pages: ['check'], adminTabs: [] };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å…¨å±€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var currentUser = null;
var dashData    = null;   // getDashboardAll() è¿”å›çš„å®Œæ•´æ•°æ®

var CAT_EMOJI = {
  'è‚‰ç±»':'ğŸ¥©','èœç±»':'ğŸ¥¬','æµ·é²œ':'ğŸ¦','è°ƒæ–™':'ğŸ§‚','é¥®æ–™':'ğŸ§ƒ',
  'ä¸»é£Ÿ':'ğŸš','è˜¸æ–™':'ğŸ²','æ²¹æ–™':'ğŸ«™','å†·å†»':'â„ï¸','å¹²è´§':'ğŸŒ¾',
  'ä¸¸å­':'ğŸœ','é”…åº•':'ğŸ«•','æ¶ˆè€—å“':'ğŸ§»'
};
function cEmoji(cat){ return CAT_EMOJI[cat] || 'ğŸ“¦'; }
function escH(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åˆå§‹åŒ–
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load', function() {
  var stored = ssGet('ims_user') || lsGet('ims_user');
  if (!stored) { goLogin(); return; }
  try { currentUser = JSON.parse(stored); } catch(e) { goLogin(); return; }

  // é¡µé¢æƒé™æ£€æŸ¥
  var myPerms = parsePermissions(currentUser.permissions, currentUser.role);
  if (myPerms.pages.indexOf('dashboard') < 0) {
    // æ²¡æœ‰çœ‹æ¿æƒé™ â†’ è·³è½¬åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨é¡µé¢
    if (myPerms.pages.indexOf('check') >= 0)      { navigateTo('check'); return; }
    if (myPerms.pages.indexOf('admin') >= 0)      { navigateTo('admin'); return; }
    goLogin(); return;
  }

  // æœ‰ admin æƒé™æ‰æ˜¾ç¤ºç®¡ç†æŒ‰é’®
  if (myPerms.pages.indexOf('admin') >= 0) {
    document.getElementById('adminBtn').style.display = 'inline-block';
  }

  document.getElementById('dateInfo').textContent =
    new Date().toLocaleDateString('zh-CN', {
      year:'numeric', month:'long', day:'numeric', weekday:'long'
    });

  loadAll();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å•æ¬¡åŠ è½½ï¼ˆgetDashboardAllï¼‰+ sessionStorage ç¼“å­˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var CACHE_KEY = 'ims_dashboard_cache';
var CACHE_TTL = 5 * 60 * 1000; // 5 åˆ†é’Ÿå†…ç¼“å­˜æœ‰æ•ˆ

function loadAll() {
  document.getElementById('bottomBar').style.display = 'none';

  // å°è¯•è¯»å–ç¼“å­˜
  try {
    var raw = sessionStorage.getItem(CACHE_KEY);
    if (raw) {
      var cached = JSON.parse(raw);
      if (cached && cached._ts && (Date.now() - cached._ts) < CACHE_TTL) {
        // ç«‹å³æ¸²æŸ“ç¼“å­˜æ•°æ®ï¼ˆæ— éœ€ç­‰å¾…ï¼‰
        dashData = cached;
        document.getElementById('loadingArea').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        renderAll(cached);
        // åŒæ—¶åœ¨åå°é™é»˜åˆ·æ–°
        _fetchFresh(true);
        return;
      }
    }
  } catch(e) {}

  // æ— ç¼“å­˜ï¼šæ˜¾ç¤º spinner
  document.getElementById('loadingArea').style.display = 'block';
  document.getElementById('loadingArea').innerHTML =
    '<div class="spinner"></div><div>åŠ è½½çœ‹æ¿æ•°æ®...</div>';
  document.getElementById('mainContent').style.display = 'none';
  _fetchFresh(false);
}

function _fetchFresh(silent) {
  google.script.run
    .withSuccessHandler(function(resp) { onDataLoaded(resp, silent); })
    .withFailureHandler(function(err) {
      if (silent) return; // åå°åˆ·æ–°å¤±è´¥ä¸æ‰“æ–­ç”¨æˆ·
      document.getElementById('loadingArea').innerHTML =
        '<div style="font-size:32px;margin-bottom:12px">âŒ</div>' +
        '<div style="color:#d32f2f;margin-bottom:16px">' + (err.message||err) + '</div>' +
        '<button onclick="loadAll()" style="padding:9px 20px;background:#d32f2f;color:#fff;' +
        'border:none;border-radius:8px;font-size:14px;cursor:pointer">é‡è¯•</button>';
    })
    .getDashboardAll();
}

function onDataLoaded(resp, silent) {
  if (!resp || !resp.success) {
    if (silent) return; // åå°åˆ·æ–°å¤±è´¥ä¸æ‰“æ–­ç”¨æˆ·
    var errMsg = resp ? (resp.error || 'success=false') : 'æœåŠ¡å™¨æ— å“åº”(respä¸ºç©º)';
    document.getElementById('loadingArea').innerHTML =
      '<div style="font-size:32px;margin-bottom:12px">âŒ</div>' +
      '<div style="color:#d32f2f;margin-bottom:8px">' + errMsg + '</div>' +
      '<button onclick="loadAll()" style="padding:9px 20px;background:#d32f2f;color:#fff;' +
      'border:none;border-radius:8px;font-size:14px;cursor:pointer">é‡è¯•</button>';
    return;
  }
  // å­˜å…¥ç¼“å­˜
  try { resp._ts = Date.now(); sessionStorage.setItem(CACHE_KEY, JSON.stringify(resp)); } catch(e) {}
  dashData = resp;
  document.getElementById('loadingArea').style.display = 'none';
  document.getElementById('mainContent').style.display = 'block';
  renderAll(resp);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ¸²æŸ“
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(d) {
  renderStats(d);
  renderProgress(d);
  renderValue(d);
  renderLowItems(d.lowItems || []);
  renderHighItems(d.highItems || []);
  renderAllStock(d.allItems || []);
  renderHistory(d.recentHistory || []);

  // åº•éƒ¨æ“ä½œ
  if ((d.lowItems || []).length > 0) {
    document.getElementById('costCard').style.display   = 'flex';
    document.getElementById('bottomBar').style.display  = 'flex';
    document.getElementById('totalCost').textContent    = 'RM ' + (d.pendingCost||0).toFixed(2);
    document.getElementById('pendingPO').textContent    = d.pendingPO || 0;
  }
}

function renderStats(d) {
  document.getElementById('statLow').textContent    = d.lowCount    || 0;
  document.getElementById('statHigh').textContent   = d.highCount   || 0;
  document.getElementById('statNormal').textContent = d.normalCount || 0;
}

function renderProgress(d) {
  var done  = d.todayChecked || 0;
  var total = d.todayTotal   || 0;
  var pct   = total > 0 ? Math.round(done / total * 100) : (total === 0 ? 100 : 0);

  document.getElementById('checkText').textContent = done + '/' + total;
  var fill = document.getElementById('checkFill');
  fill.style.width = pct + '%';
  fill.className   = 'progress-fill' + (pct >= 100 ? ' done' : '');
  document.getElementById('checkNote').textContent =
    pct >= 100 ? 'âœ… ä»Šæ—¥ç›˜ç‚¹å·²å®Œæˆ' :
    total === 0 ? 'ä»Šæ—¥æ— éœ€ç›˜ç‚¹' :
    'å¾…ç›˜ç‚¹ ' + (total - done) + ' é¡¹';
}

function renderValue(d) {
  document.getElementById('totalValue').textContent = 'RM ' + (d.totalValue||0).toFixed(2);
  document.getElementById('totalItems').textContent = d.total || 0;
}

function renderLowItems(items) {
  var titleEl = document.getElementById('lowTitle');
  var listEl  = document.getElementById('lowList');
  titleEl.textContent = 'ğŸ”´ éœ€è¡¥è´§ (' + items.length + 'é¡¹)';
  if (!items.length) {
    listEl.innerHTML = '<div class="empty-state">âœ… æ‰€æœ‰ç‰©å“åº“å­˜å……è¶³</div>';
    return;
  }
  var html = '';
  items.forEach(function(it) {
    var urg = (it.urgency || 100) < 30 ? 'urg-critical' : 'urg-warning';
    html += '<div class="stock-item">' +
      '<div class="urgency-bar ' + urg + '"></div>' +
      '<div class="si-info">' +
        '<div class="si-name">' + escH(it.name) + '</div>' +
        '<div class="si-detail">å½“å‰ ' + it.currentQty + it.unit +
          ' / æœ€ä½ ' + it.minStock + it.unit + '</div>' +
        (it.supplier ? '<div class="si-supplier">ğŸ“¦ ' + escH(it.supplier) + '</div>' : '') +
      '</div>' +
      '<div class="si-right">' +
        '<div class="si-need">+' + it.need + it.unit + '</div>' +
        (it.price > 0 ? '<div class="si-cost">â‰ˆ RM ' + (it.totalCost||0).toFixed(2) + '</div>'
                      : '<div class="si-cost" style="color:#ff9800">æœªè®¾ä»·</div>') +
      '</div></div>';
  });
  listEl.innerHTML = html;
}

function renderHighItems(items) {
  var titleEl = document.getElementById('highTitle');
  var listEl  = document.getElementById('highList');
  if (!items.length) { titleEl.style.display = 'none'; listEl.innerHTML = ''; return; }
  titleEl.style.display = 'block';
  titleEl.textContent   = 'ğŸŸ¡ åº“å­˜åé«˜ (' + items.length + 'é¡¹)';
  var html = '';
  items.forEach(function(it) {
    html += '<div class="stock-item">' +
      '<div class="urgency-bar urg-high"></div>' +
      '<div class="si-info">' +
        '<div class="si-name">' + escH(it.name) + '</div>' +
        '<div class="si-detail">' + escH(it.category||'') + '</div>' +
      '</div>' +
      '<div class="si-right">' +
        '<div class="si-excess">' + it.currentQty + '/' + it.maxStock + it.unit + '</div>' +
        '<div class="si-cost">è¶…å‡º +' + it.excess + '</div>' +
      '</div></div>';
  });
  listEl.innerHTML = html;
}

function renderAllStock(items) {
  var titleEl = document.getElementById('allTitle');
  var listEl  = document.getElementById('allList');
  titleEl.textContent = 'ğŸ“¦ å…¨éƒ¨åº“å­˜ (' + items.length + 'é¡¹)';

  if (!items.length) {
    listEl.innerHTML = '<div class="empty-state">æš‚æ— åº“å­˜æ•°æ®</div>';
    return;
  }

  // æŒ‰åˆ†ç±»åˆ†ç»„
  var groups = {}, order = [];
  items.forEach(function(it) {
    var cat = it.category || 'æœªåˆ†ç±»';
    if (!groups[cat]) { groups[cat] = []; order.push(cat); }
    groups[cat].push(it);
  });

  var html = '';
  order.forEach(function(cat, ci) {
    var arr  = groups[cat];
    var icon = cEmoji(cat);
    var nLow = 0, nHigh = 0;
    arr.forEach(function(it) {
      if (it.currentQty < it.minStock && it.minStock > 0) nLow++;
      else if (it.currentQty > it.maxStock && it.maxStock > 0) nHigh++;
    });
    var badge = (nLow  ? '<span style="color:#d32f2f">ğŸ”´' + nLow + '</span> ' : '') +
                (nHigh ? '<span style="color:#ff9800">ğŸŸ¡' + nHigh + '</span> ' : '') +
                '<span style="color:#388e3c">ğŸŸ¢' + (arr.length - nLow - nHigh) + '</span>';
    var bodyId = 'catb_' + ci;

    html += '<div class="cat-header" onclick="toggleCat(\'' + bodyId + '\',this)">' +
      '<span>' + icon + ' ' + escH(cat) + ' (' + arr.length + ')</span>' +
      '<span>' + badge + ' <span class="chevron">â–¶</span></span>' +
    '</div>';
    html += '<div class="cat-body" id="' + bodyId + '">';
    arr.forEach(function(it) {
      var dotCls = (it.currentQty < it.minStock && it.minStock > 0) ? 'dot-low' :
                   (it.currentQty > it.maxStock && it.maxStock > 0) ? 'dot-high' : 'dot-ok';
      html += '<div class="all-item">' +
        '<div class="dot ' + dotCls + '"></div>' +
        '<div class="ai-name">' + escH(it.name) + '</div>' +
        '<div class="ai-qty">' +
          '<div class="qn">' + it.currentQty + ' ' + escH(it.unit||'') + '</div>' +
          '<div class="qr">' + it.minStock + '~' + it.maxStock + '</div>' +
        '</div></div>';
    });
    html += '</div>';
  });
  listEl.innerHTML = html;
}

function toggleCat(bodyId, header) {
  var body = document.getElementById(bodyId);
  if (!body) return;
  var open = body.classList.toggle('open');
  var ch   = header.querySelector('.chevron');
  if (ch) ch.textContent = open ? 'â–¼' : 'â–¶';
}

function renderHistory(hist) {
  var listEl = document.getElementById('histList');
  if (!hist.length) {
    listEl.innerHTML = '<div class="empty-state">æœ€è¿‘7å¤©æ— ç›˜ç‚¹è®°å½•</div>';
    return;
  }
  var html = '';
  hist.forEach(function(h) {
    var badge = h.abnormalCount > 0
      ? '<span class="hist-badge badge-abnormal">âš ï¸ å¼‚å¸¸ ' + h.abnormalCount + '</span>'
      : '<span class="hist-badge badge-ok">âœ… æ­£å¸¸</span>';
    html += '<div class="hist-row">' +
      '<div>' +
        '<div class="hist-date">' + escH(h.date) + badge + '</div>' +
        '<div class="hist-meta">ç›˜ç‚¹ ' + h.itemCount + ' é¡¹ Â· ' + escH(h.staff||'--') + '</div>' +
      '</div>' +
      '<div style="font-size:12px;color:#9e9e9e">' +
        (h.lowStockCount > 0 ? 'ğŸ”´' + h.lowStockCount + ' ' : '') +
        (h.highStockCount > 0 ? 'ğŸŸ¡' + h.highStockCount : '') +
      '</div></div>';
  });
  listEl.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// é‡‡è´­å•æ“ä½œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generatePO() {
  var lowCnt = dashData && dashData.lowItems ? dashData.lowItems.length : 0;
  if (!confirm('ç¡®è®¤ç”Ÿæˆé‡‡è´­å•ï¼Ÿå°†åŒ…å« ' + lowCnt + ' é¡¹ä½åº“å­˜ç‰©å“')) return;
  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        alert(r.itemCount > 0
          ? 'âœ… é‡‡è´­å•å·²ç”Ÿæˆ\nå•å·: ' + r.poId + '\nç‰©å“: ' + r.itemCount + 'é¡¹\næ€»é¢: RM ' + r.totalCost
          : 'âœ… å½“å‰æ— éœ€è¡¥è´§');
        loadAll();
      } else { alert('âŒ ç”Ÿæˆå¤±è´¥: ' + (r.error||'')); }
    })
    .withFailureHandler(function(e){ alert('âŒ é”™è¯¯: ' + (e.message||e)); })
    .generatePurchaseOrder();
}

function sendWhatsApp() {
  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        var a = document.createElement('a');
        a.href = 'https://wa.me/?text=' + encodeURIComponent(r.text);
        a.target = '_blank';
        document.body.appendChild(a);
        a.click();
      } else { alert('è·å–é‡‡è´­å•å¤±è´¥: ' + (r.error||'')); }
    })
    .withFailureHandler(function(e){ alert('é”™è¯¯: ' + (e.message||e)); })
    .getPurchaseOrderText();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å¯¼èˆª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function navigateTo(page) {
  google.script.run.withSuccessHandler(function(url) {
    var a = document.createElement('a');
    a.href = url + '?page=' + page;
    a.target = '_top';
    document.body.appendChild(a);
    a.click();
  }).getAppUrl();
}
function goLogin() {
  lsDel('ims_user');
  navigateTo('login');
}
function doLogout() {
  lsDel('ims_user');
  try { sessionStorage.removeItem('ims_user'); } catch(e) {}
  navigateTo('login');
}
</script>
</body>
</html>
