<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; padding-bottom: 90px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    
    .login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #d93025; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column;}
    .lang-switch-login { position: absolute; top: 15px; right: 15px; }
    .lang-btn { background: rgba(255,255,255,0.25); border: 1px solid rgba(255,255,255,0.6); color: white; border-radius: 20px; padding: 5px 15px; font-size: 0.85rem; backdrop-filter: blur(4px); font-weight: bold; }
    
    .item-card { background: white; border-radius: 12px; padding: 12px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; position: relative; }
    .item-img { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; margin-right: 15px; background-color: #eee; border: 1px solid #eee; cursor: zoom-in; }
    .btn-edit-item { position: absolute; top: 10px; right: 10px; font-size: 1.2rem; color: #adb5bd; cursor: pointer; display: none; } 
    
    .qty-input { width: 70px; height: 45px; text-align: center; font-size: 1.2rem; font-weight: bold; border: 1px solid #ced4da; border-radius: 8px; background-color: #fff; }
    .qty-input:focus { border-color: #d93025; box-shadow: 0 0 0 0.2rem rgba(217, 48, 37, 0.25); outline: 0; }
    
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-around; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
    .nav-btn { text-align: center; color: #adb5bd; font-size: 0.75rem; background: none; border: none; padding: 5px 20px; display: none; }
    .nav-btn.active { color: #d93025; font-weight: 700; }
    .nav-icon { display: block; font-size: 1.5rem; margin-bottom: 2px; }
    
    .page-section { display: none; animation: fadeIn 0.3s; }
    .page-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .cat-scroll { overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; padding-bottom: 5px; }
    .cat-btn { border-radius: 20px; margin-right: 8px; padding: 5px 15px; font-size: 0.9rem; }
    
    .perm-check-group { display: flex; flex-wrap: wrap; gap: 10px; }
    .perm-check-item { background: #f1f3f5; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem; }

    /* å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡† */
    .img-zoom-modal { 
      display: none; position: fixed; z-index: 10002; left: 0; top: 0; width: 100%; height: 100%; 
      background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; animation: fadeIn 0.2s;
    }
    .img-zoom-content { max-width: 95%; max-height: 80%; border-radius: 5px; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
    .img-zoom-close { position: absolute; top: 20px; right: 20px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }
    
    /* é¢‘ç‡åˆ‡æ¢æŒ‰é’® */
    .freq-toggle { display: inline-block; background: #eee; padding: 3px; border-radius: 20px; margin-bottom: 10px; }
    .freq-btn { border: none; background: none; padding: 5px 15px; border-radius: 15px; font-size: 0.85rem; color: #666; transition: 0.3s; }
    .freq-btn.active { background: #d93025; color: white; font-weight: bold; }
  </style>
</head>
<body>

  <div id="loginSection" class="login-screen">
    <div class="lang-switch-login"><button class="btn lang-btn" onclick="toggleLanguage()">ğŸ‡¨ğŸ‡³ / ğŸ‡²ğŸ‡²</button></div>
    <div class="card p-4 shadow" style="width: 85%; max-width: 350px; border:none; border-radius: 15px;">
      <div class="text-center mb-4">
        <h4 class="fw-bold text-danger" id="lbl_login_title">å¼ å´‡ä¼šç«é”…</h4>
        <small class="text-muted" id="lbl_login_subtitle">å‘˜å·¥åº“å­˜ç³»ç»Ÿ</small>
      </div>
      <div class="mb-3"><input type="text" id="loginUser" class="form-control form-control-lg" placeholder="admin"></div>
      <div class="mb-4"><input type="password" id="loginPass" class="form-control form-control-lg" placeholder="1234"></div>
      <button onclick="doLogin()" class="btn btn-danger w-100 btn-lg rounded-pill" id="btn_login">ç™» å½•</button>
    </div>
  </div>

  <div id="mainApp" style="display:none;">
    <div class="bg-danger text-white p-3 shadow-sm sticky-top d-flex justify-content-between align-items-center">
      <span class="fw-bold h5 m-0" id="pageTitle">æ¯æ—¥ç›˜ç‚¹</span>
      <div>
        <span class="badge bg-white text-danger rounded-pill me-1" id="displayUser">User</span>
        <button class="btn btn-sm btn-warning rounded-pill me-1" style="font-size:0.7rem; font-weight:bold" onclick="doLogout()" id="btn_logout">é€€å‡º</button>
        <button class="btn btn-sm btn-outline-light rounded-pill" style="font-size:0.7rem" onclick="toggleLanguage()">æ–‡/MY</button>
      </div>
    </div>

    <div class="container mt-3">
      
      <div id="page-stocktake" class="page-section active">
        
        <div class="text-center">
          <div class="freq-toggle">
            <button class="freq-btn active" onclick="filterFreq('Daily', this)" id="btn_freq_daily">â˜€ï¸ æ¯æ—¥ç›˜ç‚¹</button>
            <button class="freq-btn" onclick="filterFreq('All', this)" id="btn_freq_all">ğŸ“‹ æ˜¾ç¤ºå…¨éƒ¨</button>
          </div>
        </div>

        <div class="cat-scroll mb-3" id="category_bar">
           <button class="btn btn-outline-danger cat-btn active" onclick="filterCategory('All', this)" id="cat_all" data-c="All">å…¨éƒ¨</button>
           <button class="btn btn-outline-danger cat-btn" onclick="filterCategory('è‚‰ç±»', this)" id="cat_meat" data-c="è‚‰ç±»">è‚‰ç±»</button>
           <button class="btn btn-outline-danger cat-btn" onclick="filterCategory('èœç±»', this)" id="cat_veg" data-c="èœç±»">èœç±»</button>
           <button class="btn btn-outline-danger cat-btn" onclick="filterCategory('é…’æ°´', this)" id="cat_drink" data-c="é…’æ°´">é…’æ°´</button>
           <button class="btn btn-outline-danger cat-btn" onclick="filterCategory('è°ƒå‘³æ–™', this)" id="cat_season" data-c="è°ƒå‘³æ–™">è°ƒæ–™</button>
           <button class="btn btn-outline-danger cat-btn" onclick="filterCategory('æ¶ˆè€—å“', this)" id="cat_misc" data-c="æ¶ˆè€—å“">æ¶ˆè€—å“</button>
           <button class="btn btn-outline-danger cat-btn" onclick="filterCategory('å°åƒ', this)" id="cat_snack" data-c="å°åƒ">å°åƒ</button>
           <button class="btn btn-outline-danger cat-btn" onclick="filterCategory('ç”œå“', this)" id="cat_dessert" data-c="ç”œå“">ç”œå“</button>
        </div>
        <div id="inventoryList"><div class="text-center mt-5 pt-5 text-muted"><div class="spinner-border text-danger mb-2"></div><div id="lbl_loading">åŠ è½½ä¸­...</div></div></div>
        <div class="d-grid gap-2 mt-4 mb-5 pb-3">
          <button onclick="submitStocktake()" class="btn btn-success btn-lg shadow rounded-pill fw-bold" id="btn_submit_stock">âœ… æäº¤ç›˜ç‚¹ç»“æœ</button>
        </div>
      </div>

      <div id="page-add" class="page-section">
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
               <button class="btn btn-outline-secondary btn-sm me-2 rounded-pill" onclick="goHome()">â¬… <span id="btn_back_home_1">è¿”å›</span></button>
               <h5 class="card-title fw-bold m-0" id="lbl_add_title">â• æ·»åŠ æ–°é£Ÿæ</h5>
            </div>
            <form id="addItemForm" onsubmit="submitAddItem(event)">
              <div class="mb-3"><label class="form-label small fw-bold" id="lbl_item_name">ç‰©å“åç§°</label><input type="text" class="form-control" name="itemName" required></div>
              <div class="row">
                <div class="col-6 mb-3"><label class="form-label small fw-bold" id="lbl_category">åˆ†ç±»</label>
                  <select class="form-select" name="category">
                    <option value="è‚‰ç±»">è‚‰ç±»</option><option value="èœç±»">èœç±»</option><option value="å°åƒ">å°åƒ</option><option value="è°ƒå‘³æ–™">è°ƒå‘³æ–™</option>
                    <option value="é…’æ°´">é…’æ°´</option><option value="ç”œå“">ç”œå“</option><option value="æ¶ˆè€—å“">æ¶ˆè€—å“</option>
                  </select>
                </div>
                <div class="col-6 mb-3"><label class="form-label small fw-bold" id="lbl_unit">å•ä½</label>
                  <select class="form-select" name="unit">
                    <option value="å…¬æ–¤">å…¬æ–¤ (kg)</option><option value="å…‹">å…‹ (g)</option>
                    <option value="åŒ…">åŒ… (Pack)</option><option value="ç®±">ç®± (Box)</option>
                    <option value="ç½">ç½ (Can)</option><option value="ç“¶">ç“¶ (Bottle)</option><option value="æ”¯">æ”¯ (Pcs)</option>
                  </select>
                </div>
              </div>
              
              <div class="mb-3">
                 <label class="form-label small fw-bold">ç›˜ç‚¹é¢‘ç‡ (Frequency)</label>
                 <select class="form-select" name="frequency">
                    <option value="Daily">Daily (æ¯æ—¥ç›˜ç‚¹)</option>
                    <option value="Weekly">Weekly (æ¯å‘¨/å‡ å¤©ä¸€æ¬¡)</option>
                 </select>
              </div>

              <div class="row">
                <div class="col-6 mb-3"><label class="form-label small fw-bold" id="lbl_min">æœ€ä½åº“å­˜</label><input type="number" class="form-control" name="minStock" placeholder="0"></div>
                <div class="col-6 mb-3"><label class="form-label small fw-bold" id="lbl_max">æœ€é«˜åº“å­˜</label><input type="number" class="form-control" name="maxStock" placeholder="0"></div>
              </div>
              <div class="mb-4 text-center">
                <input type="file" id="hiddenCameraInput" accept="image/*" capture="environment" style="display:none" onchange="handlePhotoSelect()">
                <button type="button" class="btn btn-outline-danger w-100 p-4 border-2" style="border-style: dashed !important; border-radius: 12px;" onclick="triggerCamera()">
                  <div style="font-size: 2.5rem;">ğŸ“·</div><div class="fw-bold mt-2" id="btn_camera_text">ç‚¹å‡»å¼€å¯ç›¸æœº</div>
                </button>
                <div id="preview-container" class="mt-3" style="display:none;"><img id="preview-image" src="" class="img-fluid rounded shadow-sm" style="max-height: 200px;"></div>
                <input type="hidden" name="imageFile" id="base64Image">
              </div>
              <button type="submit" class="btn btn-danger w-100 btn-lg rounded-pill shadow" id="btn_save_item">ğŸ’¾ ä¿å­˜æ–°ç‰©å“</button>
            </form>
          </div>
        </div>
      </div>

      <div id="page-user" class="page-section">
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
               <button class="btn btn-outline-secondary btn-sm me-2 rounded-pill" onclick="goHome()">â¬… <span id="btn_back_home_2">è¿”å›</span></button>
               <h5 class="card-title fw-bold m-0">ğŸ‘¤ å‘˜å·¥è´¦å·ç®¡ç†</h5>
            </div>
            <form id="addUserForm" onsubmit="submitAddUser(event)">
              <div class="mb-3"><input type="text" class="form-control" name="newUsername" required placeholder="è´¦å·"></div>
              <div class="mb-3"><input type="text" class="form-control" name="newPassword" required placeholder="å¯†ç "></div>
              <div class="mb-3">
                <select class="form-select" name="newRole">
                  <option value="Staff">Staff (ä»…ç›˜ç‚¹)</option>
                  <option value="Manager">Manager (å¯æ”¹ç‰©å“)</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label small fw-bold">è´Ÿè´£ç›˜ç‚¹çš„åˆ†ç±»</label>
                <div class="perm-check-group">
                  <label class="perm-check-item"><input type="checkbox" name="permCat" value="è‚‰ç±»"> è‚‰ç±»</label>
                  <label class="perm-check-item"><input type="checkbox" name="permCat" value="èœç±»"> èœç±»</label>
                  <label class="perm-check-item"><input type="checkbox" name="permCat" value="é…’æ°´"> é…’æ°´</label>
                  <label class="perm-check-item"><input type="checkbox" name="permCat" value="è°ƒå‘³æ–™"> è°ƒæ–™</label>
                  <label class="perm-check-item"><input type="checkbox" name="permCat" value="æ¶ˆè€—å“"> æ¶ˆè€—</label>
                  <label class="perm-check-item"><input type="checkbox" name="permCat" value="å°åƒ"> å°åƒ</label>
                  <label class="perm-check-item"><input type="checkbox" name="permCat" value="ç”œå“"> ç”œå“</label>
                </div>
              </div>
              <button type="submit" class="btn btn-dark w-100 rounded-pill">åˆ›å»ºè´¦å·</button>
            </form>
          </div>
        </div>
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <h5 class="card-title fw-bold mb-3">ğŸ“‹ ç°æœ‰å‘˜å·¥åˆ—è¡¨</h5>
            <div id="staffListContainer" class="list-group">
              <div class="text-center text-muted p-3">åŠ è½½ä¸­...</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <div id="imgZoomModal" class="img-zoom-modal" onclick="closeImgZoom()"><span class="img-zoom-close">&times;</span><img class="img-zoom-content" id="imgZoomTarget"></div>

    <div class="bottom-nav">
      <button class="nav-btn" id="nav_btn_stock" onclick="switchPage('stocktake', this)">
        <span class="nav-icon">ğŸ“‹</span> <span id="nav_stocktake">ç›˜ç‚¹</span>
      </button>
      <button class="nav-btn" id="nav_btn_add" onclick="switchPage('add', this)">
        <span class="nav-icon">ğŸ“·</span> <span id="nav_add">æ–°å¢</span>
      </button>
      <button class="nav-btn" id="nav_btn_user" onclick="switchPage('user', this)">
        <span class="nav-icon">ğŸ‘¤</span> <span>ç®¡ç†</span>
      </button>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    let CURRENT_USER = "";
    let CURRENT_ROLE = "";
    let CURRENT_PERMS = [];
    let CURRENT_FREQ = "Daily"; // é»˜è®¤åªçœ‹ Daily
    let LANG = "cn"; 
    
    // I18N
    const I18N = {
      cn: {
        login_title: "å¼ å´‡ä¼šç«é”…", btn_login: "ç™» å½•", btn_logout: "é€€å‡º", btn_back: "è¿”å›é¦–é¡µ",
        page_stock: "æ¯æ—¥ç›˜ç‚¹", btn_submit: "âœ… æäº¤ç›˜ç‚¹ç»“æœ",
        cat_all: "å…¨éƒ¨", cat_meat: "è‚‰ç±»", cat_veg: "èœç±»", cat_drink: "é…’æ°´", cat_season: "è°ƒæ–™", cat_misc: "æ¶ˆè€—å“", cat_snack: "å°åƒ", cat_dessert: "ç”œå“",
        nav_stock: "ç›˜ç‚¹", nav_add: "æ–°å¢",
        lbl_add_title: "â• æ·»åŠ æ–°é£Ÿæ", btn_camera: "ç‚¹å‡»å¼€å¯ç›¸æœº", btn_save: "ğŸ’¾ ä¿å­˜æ–°ç‰©å“",
        opt_meat: "è‚‰ç±»", opt_veg: "èœç±»", opt_snack: "å°åƒ", opt_season: "è°ƒå‘³æ–™", opt_drink: "é…’æ°´", opt_dessert: "ç”œå“", opt_misc: "æ¶ˆè€—å“",
        btn_freq_daily: "â˜€ï¸ æ¯æ—¥ç›˜ç‚¹", btn_freq_all: "ğŸ“‹ æ˜¾ç¤ºå…¨éƒ¨"
      },
      my: {
        login_title: "Zhang Chong Hui", btn_login: "Login", btn_logout: "Logout", btn_back: "Back",
        page_stock: "á€”á€±á€·á€…á€‰á€ºá€•á€…á€¹á€…á€Šá€ºá€¸á€…á€¬á€›á€„á€ºá€¸", btn_submit: "âœ… á€…á€¬á€›á€„á€ºá€¸á€á€„á€ºá€á€½á€„á€ºá€¸á€™á€Šá€º",
        cat_all: "á€¡á€¬á€¸á€œá€¯á€¶á€¸", cat_meat: "á€¡á€á€¬á€¸", cat_veg: "á€¡á€›á€½á€€á€º", cat_drink: "á€¡á€á€»á€­á€¯á€›á€Šá€º", cat_season: "á€¡á€›á€á€¬á€™á€¾á€¯á€”á€·á€º", cat_misc: "á€¡á€á€¼á€¬á€¸", cat_snack: "á€¡á€†á€¬á€•á€¼á€±", cat_dessert: "á€¡á€á€»á€­á€¯á€•á€½á€²",
        nav_stock: "á€…á€¬á€›á€„á€ºá€¸", nav_add: "á€¡á€á€…á€º",
        lbl_add_title: "â• á€•á€…á€¹á€…á€Šá€ºá€¸á€¡á€á€…á€ºá€‘á€Šá€·á€ºá€›á€”á€º", btn_camera: "á€“á€¬á€á€ºá€•á€¯á€¶á€›á€­á€¯á€€á€ºá€›á€”á€º", btn_save: "ğŸ’¾ á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€™á€Šá€º",
        opt_meat: "á€¡á€á€¬á€¸", opt_veg: "á€¡á€›á€½á€€á€º", opt_snack: "á€¡á€†á€¬á€•á€¼á€±", opt_season: "á€¡á€›á€á€¬á€™á€¾á€¯á€”á€·á€º", opt_drink: "á€¡á€á€»á€­á€¯á€›á€Šá€º", opt_dessert: "á€¡á€á€»á€­á€¯á€•á€½á€²", opt_misc: "á€¡á€á€¼á€¬á€¸",
        btn_freq_daily: "â˜€ï¸ á€”á€±á€·á€…á€‰á€º", btn_freq_all: "ğŸ“‹ á€¡á€¬á€¸á€œá€¯á€¶á€¸"
      }
    };

    function toggleLanguage() { LANG = LANG === "cn" ? "my" : "cn"; updateUIText(); }
    function updateUIText() {
      const t = I18N[LANG];
      setText('lbl_login_title', t.login_title); setText('btn_login', t.btn_login); setText('btn_logout', t.btn_logout);
      setText('btn_submit_stock', t.btn_submit); setText('nav_stocktake', t.nav_stock); setText('nav_add', t.nav_add);
      setText('pageTitle', t.page_stock);
      setText('cat_all', t.cat_all); setText('cat_meat', t.cat_meat); setText('cat_veg', t.cat_veg);
      setText('cat_drink', t.cat_drink); setText('cat_season', t.cat_season); setText('cat_misc', t.cat_misc);
      setText('cat_snack', t.cat_snack); setText('cat_dessert', t.cat_dessert);
      setText('lbl_add_title', t.lbl_add_title); setText('btn_camera_text', t.btn_camera); setText('btn_save_item', t.btn_save);
      setText('btn_back_home_1', t.btn_back); setText('btn_back_home_2', t.btn_back);
      setText('btn_freq_daily', t.btn_freq_daily); setText('btn_freq_all', t.btn_freq_all);
    }
    function setText(id, text) { const el = document.getElementById(id); if(el) el.innerText = text; }

    function doLogin() {
      const u = document.getElementById('loginUser').value;
      const p = document.getElementById('loginPass').value;
      if(!u || !p) return Swal.fire('è¯·è¾“å…¥è´¦å·å¯†ç ');
      Swal.showLoading();
      google.script.run.withSuccessHandler(res => {
        Swal.close();
        if (res.success) {
          CURRENT_USER = res.user; CURRENT_ROLE = res.role;
          if (res.permissions === 'All') CURRENT_PERMS = ['All']; else CURRENT_PERMS = res.permissions.split(',');
          document.getElementById('displayUser').innerText = res.user;
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('mainApp').style.display = 'block';
          setupUIByRole(res.role);
          filterCategoryButtons(); 
          loadInventory();
        } else { Swal.fire('Error', res.message, 'error'); }
      }).checkLogin(u, p);
    }

    function doLogout() {
      CURRENT_USER = ""; CURRENT_ROLE = ""; CURRENT_PERMS = [];
      document.getElementById('loginUser').value = ""; document.getElementById('loginPass').value = "";
      document.getElementById('mainApp').style.display = 'none';
      document.getElementById('loginSection').style.display = 'flex';
    }

    function setupUIByRole(role) {
      document.getElementById('nav_btn_add').style.display = (role === 'Staff') ? 'none' : 'block';
      document.getElementById('nav_btn_user').style.display = (role === 'Boss') ? 'block' : 'none';
      goHome(); if (role === 'Boss') loadStaffList();
    }
    function goHome() { switchPage('stocktake', document.getElementById('nav_btn_stock')); }

    function filterCategoryButtons() {
      const btns = document.querySelectorAll('#category_bar .cat-btn');
      btns.forEach(btn => {
        const catName = btn.getAttribute('data-c');
        if (CURRENT_PERMS.includes('All')) {
           btn.style.display = 'inline-block';
        } else {
           if (catName === 'All' || CURRENT_PERMS.includes(catName)) {
              btn.style.display = 'inline-block';
           } else {
              btn.style.display = 'none';
           }
        }
      });
      if (CURRENT_PERMS.includes('All')) {
         filterCategory('All', document.getElementById('cat_all'));
      }
    }

    // === æ–°å¢ï¼šé¢‘ç‡è¿‡æ»¤ ===
    function filterFreq(freq, btn) {
      CURRENT_FREQ = freq;
      document.querySelectorAll('.freq-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      loadInventory(); // é‡æ–°åŠ è½½å¹¶æ¸²æŸ“
    }

    function loadInventory() { google.script.run.withSuccessHandler(renderItems).getInventoryData(); }

    function renderItems(items) {
      const container = document.getElementById('inventoryList');
      container.innerHTML = "";
      let visibleCount = 0;
      
      const activeBtn = document.querySelector('#category_bar .cat-btn.active');
      const currentCatFilter = activeBtn ? activeBtn.getAttribute('data-c') : 'All';

      items.forEach(item => {
        // 1. æƒé™è¿‡æ»¤
        if (CURRENT_PERMS.includes('All') || CURRENT_PERMS.includes(item.category)) {
          // 2. é¢‘ç‡è¿‡æ»¤ (å¦‚æœé€‰äº†Daily, åªæ˜¾ç¤ºDailyç‰©å“; å¦‚æœé€‰All, æ˜¾ç¤ºæ‰€æœ‰)
          if (CURRENT_FREQ === 'All' || item.frequency === 'Daily') {
             // 3. Tabè¿‡æ»¤
             if (currentCatFilter === 'All' || currentCatFilter === item.category) {
                 visibleCount++;
                 const imgDisplay = item.image ? `<img src="${item.image}" class="item-img" onclick="showImgZoom('${item.image}')">` : `<div class="item-img text-muted small">No Img</div>`;
                 let editBtn = (CURRENT_ROLE === 'Boss' || CURRENT_ROLE === 'Manager') ? `<div class="btn-edit-item" onclick='openEditModal(${JSON.stringify(item)})'>âœï¸</div>` : "";
                 
                 const html = `
                   <div class="item-card" data-category="${item.category}">
                     ${editBtn}
                     ${imgDisplay}
                     <div class="flex-grow-1">
                       <div class="fw-bold text-dark fs-5">${item.name}</div>
                       <div class="text-muted small">å½“å‰: ${item.currentQty} ${item.unit} (${item.frequency==='Daily'?'æ—¥':'å‘¨'})</div>
                     </div>
                     <div><input type="number" class="qty-input stock-input" data-id="${item.id}" data-name="${item.name}" value="${item.currentQty}" onfocus="this.select()"></div>
                   </div>`;
                 container.insertAdjacentHTML('beforeend', html);
             }
          }
        }
      });
      
      if(visibleCount === 0) container.innerHTML = '<div class="text-center p-5 text-muted">æ— ç‰©å“</div>';
      
      if (CURRENT_ROLE === 'Boss' || CURRENT_ROLE === 'Manager') {
        document.querySelectorAll('.btn-edit-item').forEach(el => el.style.display = 'block');
      }
    }

    function filterCategory(cat, btn) {
      document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active', 'btn-danger', 'text-white'));
      document.querySelectorAll('.cat-btn').forEach(b => b.classList.add('btn-outline-danger'));
      btn.classList.remove('btn-outline-danger'); btn.classList.add('active', 'btn-danger', 'text-white');
      loadInventory(); // é‡æ–°æ¸²æŸ“ä»¥åº”ç”¨è¿‡æ»¤
    }

    function showImgZoom(imgUrl) { if(imgUrl) { document.getElementById('imgZoomTarget').src=imgUrl; document.getElementById('imgZoomModal').style.display='flex'; } }
    function closeImgZoom() { document.getElementById('imgZoomModal').style.display='none'; }

    function submitAddUser(e) {
      e.preventDefault(); const f=document.getElementById('addUserForm');
      const cbs=document.querySelectorAll('input[name="permCat"]:checked'); let arr=[]; cbs.forEach(c=>arr.push(c.value));
      
      // ä¿®æ”¹ï¼šåªæœ‰ Boss å¼ºåˆ¶ All
      let pStr = (f.newRole.value === 'Boss') ? 'All' : (arr.length>0 ? arr.join(',') : '');
      if (f.newRole.value !== 'Boss' && pStr === "") return Swal.fire('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåˆ†ç±»');
      
      const d={newUsername:f.newUsername.value, newPassword:f.newPassword.value, newRole:f.newRole.value, permissions:pStr};
      Swal.showLoading(); google.script.run.withSuccessHandler(res=>{if(res.success){Swal.fire('æˆåŠŸ','è´¦å·å·²åˆ›å»º','success');f.reset();loadStaffList();}else{Swal.fire('å¤±è´¥',res.message,'error');}}).handleCreateUser(d,CURRENT_USER);
    }

    function loadStaffList(){ google.script.run.withSuccessHandler(renderStaffList).getStaffList(CURRENT_USER); }
    function renderStaffList(users){
      const c=document.getElementById('staffListContainer'); c.innerHTML=""; if(users.length===0){c.innerHTML='<div class="text-center p-3 text-muted">Empty</div>';return;}
      users.forEach(u=>{
        let pB=u.permissions==='All'?'<span class="badge bg-success">å…¨éƒ¨æƒé™</span>':`<span class="badge bg-secondary text-wrap">${u.permissions}</span>`;
        let rB=u.role==='Boss'?'<span class="badge bg-dark">Boss</span>':(u.role==='Manager'?'<span class="badge bg-primary">Manager</span>':'<span class="badge bg-info text-dark">Staff</span>');
        let html=`<div class="list-group-item d-flex justify-content-between align-items-center" onclick='editStaff(${JSON.stringify(u)})' style="cursor:pointer"><div><div class="fw-bold">${u.username} ${rB}</div><div class="small text-muted">Pass: ${u.password}</div><div class="mt-1">${pB}</div></div><div class="text-muted">âœï¸</div></div>`;
        c.insertAdjacentHTML('beforeend',html);
      });
    }

    function editStaff(user){
      const cats=["è‚‰ç±»","èœç±»","é…’æ°´","è°ƒå‘³æ–™","æ¶ˆè€—å“","å°åƒ","ç”œå“"];
      let h=""; cats.forEach(c=>{ let k=(user.permissions.includes(c)||user.permissions==='All')?'checked':''; h+=`<label class="perm-check-item me-2 mb-2"><input type="checkbox" class="edit-perm-check" value="${c}" ${k}> ${c}</label>`; });
      Swal.fire({
        title: `ç¼–è¾‘: ${user.username}`,
        html: `<label class="d-block text-start small fw-bold mt-2">å¯†ç </label><input id="edit_u_pass" class="swal2-input m-0 w-100" value="${user.password}">
               <label class="d-block text-start small fw-bold mt-3">è§’è‰²</label><select id="edit_u_role" class="swal2-select m-0 w-100"><option value="Staff" ${user.role==='Staff'?'selected':''}>Staff</option><option value="Manager" ${user.role==='Manager'?'selected':''}>Manager</option><option value="Boss" ${user.role==='Boss'?'selected':''}>Boss</option></select>
               <label class="d-block text-start small fw-bold mt-3 mb-2">ç›˜ç‚¹æƒé™</label><div class="d-flex flex-wrap">${h}</div>`,
        showCancelButton:true, confirmButtonText:'ä¿å­˜',
        preConfirm:()=>{
           const np=document.getElementById('edit_u_pass').value; const nr=document.getElementById('edit_u_role').value;
           let nper=""; 
           // ä¿®æ”¹ï¼šåªæœ‰ Boss å¼ºåˆ¶ All
           if(nr==='Boss') nper="All"; 
           else { const c=document.querySelectorAll('.edit-perm-check:checked'); let a=[]; c.forEach(x=>a.push(x.value)); nper=a.join(','); }
           return {username:user.username, password:np, role:nr, permissions:nper};
        }
      }).then(r=>{if(r.isConfirmed){Swal.showLoading(); google.script.run.withSuccessHandler(res=>{if(res.success){Swal.fire('æˆåŠŸ','å·²æ›´æ–°','success');loadStaffList();}else{Swal.fire('å¤±è´¥',res.message,'error');}}).handleUpdateStaff(r.value,CURRENT_USER);}});
    }

    // === æ›´æ–°ï¼šç¼–è¾‘ç‰©å“å¼¹çª— (å«é¢‘ç‡/åº“å­˜è®¾ç½®) ===
    function openEditModal(item){
       Swal.fire({
        title: 'ç®¡ç†ç‰©å“',
        html: `
          <div class="mb-2 text-start small fw-bold">åç§°</div>
          <input id="e_name" class="swal2-input m-0 w-100 mb-2" value="${item.name}">
          
          <div class="mb-2 text-start small fw-bold">ç›˜ç‚¹é¢‘ç‡</div>
          <select id="e_freq" class="swal2-select m-0 w-100 mb-3">
             <option value="Daily" ${item.frequency==='Daily'?'selected':''}>Daily (æ¯æ—¥)</option>
             <option value="Weekly" ${item.frequency==='Weekly'?'selected':''}>Weekly (æ¯å‘¨/å…¶ä»–)</option>
          </select>

          <div class="d-flex gap-2">
             <div class="w-50">
               <div class="text-start small fw-bold">æœ€ä½åº“å­˜</div>
               <input id="e_min" type="number" class="swal2-input m-0 w-100" value="${item.minStock}">
             </div>
             <div class="w-50">
               <div class="text-start small fw-bold">æœ€é«˜åº“å­˜</div>
               <input id="e_max" type="number" class="swal2-input m-0 w-100" value="${item.maxStock}">
             </div>
          </div>
        `,
        showCancelButton:true, confirmButtonText:'ä¿å­˜',
        preConfirm:()=>{
           return{
             id:item.id,
             name:document.getElementById('e_name').value,
             frequency:document.getElementById('e_freq').value,
             category:item.category, unit:item.unit,
             minStock:document.getElementById('e_min').value,
             maxStock:document.getElementById('e_max').value
           }
        }
      }).then(r=>{if(r.isConfirmed)google.script.run.withSuccessHandler(()=>{
         Swal.fire('å·²æ›´æ–°'); loadInventory();
      }).handleUpdateItem(r.value,CURRENT_USER)});
    }

    function submitStocktake(){const i=document.querySelectorAll('.stock-input');let u=[];i.forEach(x=>u.push({id:x.dataset.id,name:x.dataset.name,newQty:x.value}));Swal.fire({title:'Confirm?',showCancelButton:true,confirmButtonText:'Yes'}).then(r=>{if(r.isConfirmed){Swal.showLoading();google.script.run.withSuccessHandler(res=>{Swal.fire('Success',res.message,'success');loadInventory();}).submitStocktake(u,CURRENT_USER);}});}
    function switchPage(pageId,btn){document.querySelectorAll('.page-section').forEach(e=>e.classList.remove('active'));document.getElementById('page-'+pageId).classList.add('active');document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));if(btn)btn.classList.add('active');if(pageId==='stocktake')loadInventory();}
    function triggerCamera(){document.getElementById('hiddenCameraInput').click();}
    function handlePhotoSelect(){const f=document.getElementById('hiddenCameraInput').files[0];if(f){const r=new FileReader();r.onload=e=>{document.getElementById('preview-image').src=e.target.result;document.getElementById('preview-container').style.display='block';document.getElementById('base64Image').value=e.target.result;};r.readAsDataURL(f);}}
    function submitAddItem(e){e.preventDefault();const f=document.getElementById('addItemForm');const d={itemName:f.itemName.value,category:f.category.value,unit:f.unit.value,minStock:f.minStock.value||0,maxStock:f.maxStock.value||0,frequency:f.frequency.value,imageFile:document.getElementById('base64Image').value,user:CURRENT_USER};Swal.showLoading();google.script.run.withSuccessHandler(res=>{if(res.success){Swal.fire('Success',res.message,'success');f.reset();document.getElementById('preview-container').style.display='none';}else{Swal.fire('Error',res.message,'error');}}).handleAddItem(d);}
  </script>
</body>
</html>