<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
    <!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root { --brand: #d32f2f; --green: #2e7d32; --orange: #f57c00; --blue: #1565c0; }
    body { background: #f5f5f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding-bottom: 90px; }
    
    .top-bar {
      background: var(--brand); color: white; padding: 16px 20px;
      position: sticky; top: 0; z-index: 100;
    }
    .top-bar h6 { margin: 0; font-weight: 700; }
    
    .stat-cards { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; padding: 16px; }
    .stat-card {
      background: white; border-radius: 12px; padding: 14px; text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .stat-num { font-size: 28px; font-weight: 700; line-height: 1.2; }
    .stat-label { font-size: 11px; color: #888; }
    
    .section-title {
      padding: 8px 20px; font-size: 14px; font-weight: 600; color: #666;
      background: #f0f0f0; border-bottom: 1px solid #e0e0e0;
    }
    
    .low-item {
      background: white; padding: 14px 20px; border-bottom: 1px solid #f0f0f0;
      display: flex; align-items: center; gap: 12px;
    }
    .low-urgency {
      width: 6px; min-height: 40px; border-radius: 3px;
      flex-shrink: 0;
    }
    .urgency-critical { background: var(--brand); }
    .urgency-warning { background: var(--orange); }
    .low-info { flex: 1; }
    .low-name { font-weight: 600; font-size: 14px; }
    .low-detail { font-size: 12px; color: #888; }
    .low-action { text-align: right; min-width: 80px; }
    .low-need { font-size: 14px; font-weight: 600; color: var(--brand); }
    .low-cost { font-size: 11px; color: #888; }
    .low-supplier { font-size: 11px; color: var(--blue); }
    
    .high-item {
      background: white; padding: 12px 20px; border-bottom: 1px solid #f0f0f0;
      display: flex; align-items: center; justify-content: space-between;
    }
    
    .check-progress {
      background: white; padding: 16px 20px; margin: 10px 16px; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .progress { height: 8px; border-radius: 4px; }
    
    .summary-box {
      background: white; margin: 10px 16px; padding: 16px; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .bottom-bar {
      position: fixed; bottom: 0; left: 0; right: 0; background: white;
      padding: 12px 16px; box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
      z-index: 100; display: flex; gap: 10px;
    }
    .btn-po {
      flex: 1; border: none; border-radius: 12px; padding: 12px; font-size: 14px;
      font-weight: 600; color: white;
    }
    .btn-po.primary { background: var(--brand); }
    .btn-po.whatsapp { background: #25d366; }
    
    .loading { text-align: center; padding: 60px 20px; color: #999; }
    .loading .spinner-border { color: var(--brand); width: 40px; height: 40px; }
    .logout-btn { background: none; border: none; color: rgba(255,255,255,0.8); font-size: 13px; }
    .empty-state { text-align: center; padding: 30px; color: #999; font-size: 14px; }
  </style>
</head>
<body>

<!-- Top Bar -->
<div class="top-bar">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h6>ğŸ² å¼ é‡è¾‰ç«é”… Â· ç™¾ä¸‡é•‡ è¡¥è´§çœ‹æ¿</h6>
      <small id="dateInfo"></small>
    </div>
    <div>
      <button class="logout-btn" onclick="loadAll()" title="åˆ·æ–°"><i class="bi bi-arrow-clockwise"></i></button>
      <button class="logout-btn" onclick="logout()"><i class="bi bi-box-arrow-right"></i></button>
    </div>
  </div>
</div>

<!-- Loading -->
<div class="loading" id="loadingDiv">
  <div class="spinner-border mb-3"></div>
  <div>åŠ è½½çœ‹æ¿æ•°æ®...</div>
</div>

<!-- Content -->
<div id="contentDiv" style="display:none">

  <!-- Stat Cards -->
  <div class="stat-cards">
    <div class="stat-card">
      <div class="stat-num" style="color:var(--brand)" id="lowNum">0</div>
      <div class="stat-label">ğŸ”´ éœ€è¡¥è´§</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:var(--orange)" id="highNum">0</div>
      <div class="stat-label">ğŸŸ¡ åé«˜</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:var(--green)" id="normalNum">0</div>
      <div class="stat-label">ğŸŸ¢ æ­£å¸¸</div>
    </div>
  </div>
  
  <!-- Check Progress -->
  <div class="check-progress">
    <div class="d-flex justify-content-between mb-1">
      <span style="font-size:13px;font-weight:600">ğŸ“‹ ä»Šæ—¥ç›˜ç‚¹</span>
      <span style="font-size:13px" id="checkText">0/0</span>
    </div>
    <div class="progress">
      <div class="progress-bar" id="checkBar" style="width:0%;background:var(--brand)"></div>
    </div>
    <div style="font-size:11px;color:#999;margin-top:4px" id="checkStaff"></div>
  </div>
  
  <!-- Low Stock List -->
  <div class="section-title" id="lowTitle">ğŸ”´ éœ€è¡¥è´§ (0é¡¹)</div>
  <div id="lowList"></div>
  
  <!-- High Stock List -->
  <div class="section-title" id="highTitle" style="display:none">ğŸŸ¡ åº“å­˜åé«˜ (0é¡¹)</div>
  <div id="highList"></div>
  
  <!-- Purchase Summary -->
  <div class="summary-box" id="summaryBox" style="display:none">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <div style="font-size:13px;color:#888">ğŸ’° è¡¥è´§é¢„ä¼°æ€»é¢</div>
        <div style="font-size:24px;font-weight:700;color:var(--brand)" id="totalCost">RM 0</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:13px;color:#888">å¾…é‡‡è´­å•</div>
        <div style="font-size:18px;font-weight:600" id="pendingPO">0</div>
      </div>
    </div>
  </div>
</div>

<!-- Bottom Bar -->
<div class="bottom-bar" id="bottomBar" style="display:none">
  <button class="btn-po primary" onclick="generatePO()">
    <i class="bi bi-clipboard-check"></i> ç”Ÿæˆé‡‡è´­å•
  </button>
  <button class="btn-po whatsapp" onclick="sendWhatsApp()">
    <i class="bi bi-whatsapp"></i> å‘é€é‡‡è´­å•
  </button>
</div>

<script>
  var dashboardData = null;
  var lowItems = [];
  var highItems = [];
  
  window.onload = function() {
    var saved = localStorage.getItem('ims_user');
    if (!saved) { goLogin(); return; }
    try {
      var user = JSON.parse(saved);
      if (user.role === 'Staff') {
        window.location.href = window.location.href.split('?')[0] + '?page=check';
        return;
      }
    } catch(e) { goLogin(); return; }
    
    document.getElementById('dateInfo').textContent = new Date().toLocaleDateString('zh-CN', {
      year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
    });
    
    loadAll();
  };
  
  function goLogin() {
    localStorage.removeItem('ims_user');
    window.location.href = window.location.href.split('?')[0] + '?page=login';
  }
  function logout() { goLogin(); }
  
  function loadAll() {
    document.getElementById('loadingDiv').style.display = 'block';
    document.getElementById('contentDiv').style.display = 'none';
    
    google.script.run.withSuccessHandler(function(result) {
      dashboardData = result;
      
      google.script.run.withSuccessHandler(function(lowResult) {
        lowItems = lowResult.success ? lowResult.items : [];
        
        google.script.run.withSuccessHandler(function(highResult) {
          highItems = highResult.success ? highResult.items : [];
          renderDashboard();
        }).getHighStockItems();
      }).getLowStockItems();
    }).withFailureHandler(function(err) {
      document.getElementById('loadingDiv').innerHTML = 
        '<div style="color:var(--brand)">âŒ ' + err.message + '</div>' +
        '<button class="btn btn-sm btn-outline-danger mt-3" onclick="loadAll()">é‡è¯•</button>';
    }).getStockDashboard();
  }
  
  function renderDashboard() {
    document.getElementById('loadingDiv').style.display = 'none';
    document.getElementById('contentDiv').style.display = 'block';
    
    if (!dashboardData.success) return;
    var d = dashboardData;
    
    // Stats
    document.getElementById('lowNum').textContent = d.lowCount;
    document.getElementById('highNum').textContent = d.highCount;
    document.getElementById('normalNum').textContent = d.normalCount;
    
    // Check progress
    document.getElementById('checkText').textContent = d.todayChecked + '/' + d.todayTotal;
    document.getElementById('checkBar').style.width = d.checkProgress + '%';
    document.getElementById('checkBar').style.background = d.checkProgress >= 100 ? 'var(--green)' : 'var(--brand)';
    
    // Low stock list
    document.getElementById('lowTitle').textContent = 'ğŸ”´ éœ€è¡¥è´§ (' + lowItems.length + 'é¡¹)';
    var lowHtml = '';
    if (lowItems.length === 0) {
      lowHtml = '<div class="empty-state">âœ… æ‰€æœ‰ç‰©å“åº“å­˜å……è¶³</div>';
    } else {
      var totalCost = 0;
      for (var i = 0; i < lowItems.length; i++) {
        var item = lowItems[i];
        totalCost += item.totalCost;
        var urgencyClass = item.urgency < 30 ? 'urgency-critical' : 'urgency-warning';
        
        lowHtml += '<div class="low-item">';
        lowHtml += '<div class="low-urgency ' + urgencyClass + '"></div>';
        lowHtml += '<div class="low-info">';
        lowHtml += '<div class="low-name">' + item.name + '</div>';
        lowHtml += '<div class="low-detail">å½“å‰ ' + item.currentQty + item.unit + ' / æœ€ä½ ' + item.minStock + item.unit + '</div>';
        if (item.supplier) lowHtml += '<div class="low-supplier">ğŸ“¦ ' + item.supplier + '</div>';
        lowHtml += '</div>';
        lowHtml += '<div class="low-action">';
        lowHtml += '<div class="low-need">+' + item.need + item.unit + '</div>';
        lowHtml += '<div class="low-cost">â‰ˆ RM ' + item.totalCost.toFixed(2) + '</div>';
        lowHtml += '</div>';
        lowHtml += '</div>';
      }
      
      // Summary
      document.getElementById('summaryBox').style.display = 'block';
      document.getElementById('totalCost').textContent = 'RM ' + totalCost.toFixed(2);
      document.getElementById('pendingPO').textContent = d.pendingPO;
      document.getElementById('bottomBar').style.display = 'flex';
    }
    document.getElementById('lowList').innerHTML = lowHtml;
    
    // High stock list
    if (highItems.length > 0) {
      document.getElementById('highTitle').style.display = 'block';
      document.getElementById('highTitle').textContent = 'ğŸŸ¡ åº“å­˜åé«˜ (' + highItems.length + 'é¡¹)';
      var highHtml = '';
      for (var j = 0; j < highItems.length; j++) {
        var h = highItems[j];
        highHtml += '<div class="high-item">';
        highHtml += '<div><strong>' + h.name + '</strong> <span style="color:#888;font-size:12px">' + h.category + '</span></div>';
        highHtml += '<div style="color:var(--orange);font-weight:600">' + h.currentQty + '/' + h.maxStock + h.unit + ' (+' + h.excess + ')</div>';
        highHtml += '</div>';
      }
      document.getElementById('highList').innerHTML = highHtml;
    }
  }
  
  // ============ Actions ============
  function generatePO() {
    if (!confirm('ç¡®è®¤ç”Ÿæˆé‡‡è´­å•ï¼Ÿå°†åŒ…å« ' + lowItems.length + ' é¡¹ä½åº“å­˜ç‰©å“')) return;
    
    google.script.run.withSuccessHandler(function(result) {
      if (result.success) {
        if (result.itemCount > 0) {
          alert('âœ… é‡‡è´­å•å·²ç”Ÿæˆ\n\nå•å·: ' + result.poId + '\nç‰©å“: ' + result.itemCount + 'é¡¹\næ€»é¢: RM ' + result.totalCost);
        } else {
          alert('âœ… å½“å‰æ— éœ€è¡¥è´§');
        }
        loadAll(); // åˆ·æ–°
      } else {
        alert('âŒ ç”Ÿæˆå¤±è´¥: ' + result.error);
      }
    }).withFailureHandler(function(err) {
      alert('âŒ é”™è¯¯: ' + err.message);
    }).generatePurchaseOrder();
  }
  
  function sendWhatsApp() {
    google.script.run.withSuccessHandler(function(text) {
      var encoded = encodeURIComponent(text);
      window.open('https://wa.me/?text=' + encoded, '_blank');
    }).withFailureHandler(function(err) {
      alert('è·å–é‡‡è´­å•å¤±è´¥: ' + err.message);
    }).getPurchaseOrderText();
  }
</script>

</body>
</html>
  </body>
</html>
