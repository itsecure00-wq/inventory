<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>å‘˜å·¥ç›˜ç‚¹</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Helvetica Neue', sans-serif;
      background: #f5f5f5;
      color: #212121;
      min-height: 100vh;
    }

    /* â”€â”€ é¡¶æ  â”€â”€ */
    .topbar {
      position: sticky; top: 0; z-index: 100;
      background: #d32f2f;
      color: #fff;
      padding: 12px 16px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 2px 6px rgba(0,0,0,.25);
    }
    .topbar-title { font-size: 16px; font-weight: 600; }
    .topbar-sub { font-size: 11px; opacity: .85; margin-top: 2px; }
    .logout-btn {
      background: rgba(255,255,255,.2);
      border: 1px solid rgba(255,255,255,.4);
      color: #fff;
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }

    /* â”€â”€ è¿›åº¦æ  â”€â”€ */
    .progress-bar-wrap {
      background: #fff;
      padding: 12px 16px 10px;
      border-bottom: 1px solid #e0e0e0;
    }
    .progress-label {
      display: flex; justify-content: space-between;
      font-size: 12px; color: #757575; margin-bottom: 6px;
    }
    .progress-track {
      height: 6px; background: #ffcdd2; border-radius: 3px; overflow: hidden;
    }
    .progress-fill {
      height: 100%; background: #d32f2f; border-radius: 3px;
      transition: width .4s ease;
    }

    /* â”€â”€ åˆ†ç±» Tab â”€â”€ */
    .cat-tabs {
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      display: flex; overflow-x: auto; gap: 0;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .cat-tabs::-webkit-scrollbar { display: none; }
    .cat-tab {
      flex: 0 0 auto;
      padding: 10px 14px;
      font-size: 13px; color: #757575;
      cursor: pointer; white-space: nowrap;
      border-bottom: 2px solid transparent;
      transition: all .2s;
    }
    .cat-tab.active {
      color: #d32f2f;
      border-bottom-color: #d32f2f;
      font-weight: 600;
    }

    /* â”€â”€ çŠ¶æ€åŒº â”€â”€ */
    .status-area {
      padding: 40px 24px;
      text-align: center;
      color: #9e9e9e;
      font-size: 14px;
    }
    .spinner {
      width: 32px; height: 32px; margin: 0 auto 14px;
      border: 3px solid #ffcdd2;
      border-top-color: #d32f2f;
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ ç‰©å“å¡ç‰‡ â”€â”€ */
    .items-list { padding: 8px 0 130px; }

    .item-card {
      background: #fff;
      margin: 6px 12px;
      border-radius: 10px;
      padding: 12px 12px 12px 12px;
      display: flex; align-items: center; gap: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,.08);
      border-left: 3px solid transparent;
      transition: border-color .2s;
    }
    .item-card.has-input { border-left-color: #4caf50; }

    /* ç‰©å“å›¾ç‰‡ */
    .item-photo {
      width: 56px; height: 56px; flex-shrink: 0;
      border-radius: 8px; overflow: hidden;
      background: #f5f5f5;
      display: flex; align-items: center; justify-content: center;
      font-size: 26px;
    }
    .item-photo img {
      width: 100%; height: 100%; object-fit: cover; display: block;
    }

    /* ç‰©å“ä¿¡æ¯ */
    .item-info { flex: 1; min-width: 0; }
    .item-name {
      font-size: 14px; font-weight: 600; color: #212121;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .item-meta { font-size: 11px; color: #9e9e9e; margin-top: 2px; }
    .item-stock { font-size: 12px; color: #616161; margin-top: 3px; }
    .stock-low  { color: #d32f2f; font-weight: 600; }
    .stock-high { color: #ff6f00; font-weight: 600; }
    .stock-ok   { color: #388e3c; }

    /* å³ä¾§è¾“å…¥ */
    .item-input-wrap {
      display: flex; flex-direction: column; align-items: flex-end; gap: 4px;
      flex-shrink: 0;
    }
    .qty-row { display: flex; align-items: center; gap: 4px; }
    .qty-input {
      width: 64px; height: 36px;
      border: 1.5px solid #e0e0e0;
      border-radius: 8px;
      text-align: center;
      font-size: 16px; font-weight: 600; color: #212121;
      background: #fafafa;
      outline: none;
      -webkit-appearance: none;
      transition: border-color .2s, background .2s;
    }
    .qty-input:focus { border-color: #d32f2f; background: #fff; }
    .qty-input.filled { border-color: #4caf50; background: #f1f8f4; }
    .qty-unit { font-size: 12px; color: #757575; min-width: 20px; }
    .qty-diff { font-size: 11px; text-align: right; min-height: 16px; }
    .diff-neg  { color: #d32f2f; }
    .diff-pos  { color: #388e3c; }
    .diff-zero { color: #9e9e9e; }

    /* â”€â”€ åº•éƒ¨æäº¤æ  â”€â”€ */
    .bottom-bar {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
      background: #fff;
      padding: 10px 16px 16px;
      box-shadow: 0 -2px 10px rgba(0,0,0,.12);
    }
    .bottom-summary {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 12px; color: #757575;
      margin-bottom: 8px;
    }
    .draft-label { color: #ff9800; display: none; }
    .submit-btn {
      width: 100%; padding: 13px;
      background: #d32f2f; color: #fff;
      border: none; border-radius: 10px;
      font-size: 16px; font-weight: 600;
      cursor: pointer;
      transition: background .15s, transform .1s;
    }
    .submit-btn:active { background: #b71c1c; transform: scale(.98); }
    .submit-btn:disabled { background: #bdbdbd; cursor: not-allowed; transform: none; }

    /* â”€â”€ å¼¹çª— â”€â”€ */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 200;
      background: rgba(0,0,0,.55);
      display: none; align-items: center; justify-content: center;
      padding: 24px;
    }
    .modal-overlay.show { display: flex; }
    .modal-box {
      background: #fff; border-radius: 14px;
      width: 100%; max-width: 360px;
      padding: 24px; text-align: center;
    }
    .modal-icon { font-size: 42px; margin-bottom: 12px; }
    .modal-title { font-size: 18px; font-weight: 700; color: #212121; margin-bottom: 8px; }
    .modal-msg { font-size: 13px; color: #616161; line-height: 1.6; margin-bottom: 20px; }
    .modal-btn {
      width: 100%; padding: 12px;
      border: none; border-radius: 8px;
      font-size: 15px; font-weight: 600;
      cursor: pointer; margin-bottom: 8px;
    }
    .modal-btn:last-child { margin-bottom: 0; }
    .modal-btn-primary   { background: #d32f2f; color: #fff; }
    .modal-btn-secondary { background: #f5f5f5; color: #616161; }

    .abnormal-list {
      text-align: left; background: #fff3e0;
      border-radius: 8px; padding: 10px 12px;
      margin-bottom: 16px; font-size: 12px;
      max-height: 160px; overflow-y: auto;
    }
    .abnormal-item { padding: 3px 0; color: #e65100; }

    .success-anim {
      font-size: 56px;
      animation: popIn .4s cubic-bezier(.17,.89,.32,1.49);
    }
    @keyframes popIn {
      0%  { transform: scale(.4); opacity: 0; }
      100%{ transform: scale(1);  opacity: 1; }
    }

    .empty-state {
      padding: 60px 24px; text-align: center; color: #9e9e9e;
    }
    .empty-state .icon { font-size: 52px; margin-bottom: 14px; }

    /* â”€â”€ Toast â”€â”€ */
    .ims-toast {
      position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
      z-index: 9999; background: rgba(33,33,33,.92); color: #fff;
      padding: 10px 20px; border-radius: 24px; font-size: 14px;
      white-space: nowrap; pointer-events: none;
      animation: toastIn .25s ease;
    }
    @keyframes toastIn {
      from { opacity: 0; transform: translateX(-50%) translateY(10px); }
      to   { opacity: 1; transform: translateX(-50%) translateY(0);    }
    }

    /* â”€â”€ æ·»åŠ ç‰©å“ FAB â”€â”€ */
    .add-item-fab {
      position: fixed; bottom: 90px; right: 16px; z-index: 150;
      width: 48px; height: 48px; border-radius: 50%;
      background: #37474f; color: #fff; border: none;
      font-size: 24px; line-height: 1;
      box-shadow: 0 3px 10px rgba(0,0,0,.3);
      cursor: pointer; display: none;
      align-items: center; justify-content: center;
    }

    /* â”€â”€ æ·»åŠ ç‰©å“ sheet modal â”€â”€ */
    .add-item-overlay {
      position: fixed; inset: 0; z-index: 200;
      background: rgba(0,0,0,.45);
      display: none; align-items: flex-end; justify-content: center;
    }
    .add-item-overlay.show { display: flex; }
    .add-item-sheet {
      background: #fff; width: 100%; max-width: 480px;
      border-radius: 18px 18px 0 0;
      padding: 12px 20px 32px;
      max-height: 90vh; overflow-y: auto;
    }
    .ai-handle {
      width: 40px; height: 4px; border-radius: 2px;
      background: #ddd; margin: 0 auto 14px;
    }
    .ai-title {
      font-size: 17px; font-weight: 700; color: #212121;
      margin-bottom: 18px; text-align: center;
    }
    .ai-photo-area {
      width: 100%; height: 110px;
      border: 2px dashed #bdbdbd; border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 6px;
      cursor: pointer; margin-bottom: 16px;
      background: #fafafa; overflow: hidden; position: relative;
    }
    .ai-photo-area img {
      width: 100%; height: 100%; object-fit: cover; border-radius: 10px;
    }
    .ai-photo-placeholder { font-size: 13px; color: #757575; text-align: center; }
    .ai-label {
      font-size: 12px; color: #757575; margin-bottom: 4px; margin-top: 10px;
      display: block;
    }
    .ai-input {
      width: 100%; padding: 10px 12px; border: 1px solid #e0e0e0;
      border-radius: 8px; font-size: 15px; color: #212121;
      background: #fafafa; margin-bottom: 2px;
    }
    .ai-input:focus { outline: none; border-color: #37474f; background: #fff; }
    .ai-save-btn {
      width: 100%; padding: 13px; margin-top: 20px;
      background: #37474f; color: #fff; border: none;
      border-radius: 10px; font-size: 16px; font-weight: 600;
      cursor: pointer;
    }
    .ai-save-btn:disabled { background: #9e9e9e; cursor: not-allowed; }
    .ai-cancel-btn {
      width: 100%; padding: 11px; margin-top: 8px;
      background: #f5f5f5; color: #616161; border: none;
      border-radius: 10px; font-size: 14px; cursor: pointer;
    }
  </style>
</head>
<body>

<!-- é¡¶æ  -->
<div class="topbar">
  <div>
    <div class="topbar-title">ğŸ”¥ åº“å­˜ç›˜ç‚¹</div>
    <div class="topbar-sub" id="staffLabel">å‘˜å·¥ç›˜ç‚¹</div>
  </div>
  <div style="display:flex;align-items:center;gap:8px">
    <button class="logout-btn" id="addItemTopBtn" onclick="openAddItemModal()"
            style="display:none;background:rgba(255,255,255,.25);border-color:rgba(255,255,255,.5)">ï¼‹ ç‰©å“</button>
    <button class="logout-btn" onclick="doLogout()">é€€å‡º</button>
  </div>
</div>

<!-- è¿›åº¦æ  -->
<div class="progress-bar-wrap">
  <div class="progress-label">
    <span id="progressText">åŠ è½½ä¸­...</span>
    <span id="progressPct">--</span>
  </div>
  <div class="progress-track">
    <div class="progress-fill" id="progressFill" style="width:0%"></div>
  </div>
</div>

<!-- åˆ†ç±» Tab -->
<div class="cat-tabs" id="catTabs"></div>

<!-- çŠ¶æ€ / åˆ—è¡¨ -->
<div id="statusArea" class="status-area">
  <div class="spinner"></div>
  <div>æ­£åœ¨åŠ è½½ç›˜ç‚¹ç‰©å“...</div>
</div>
<div class="items-list" id="itemsList" style="display:none"></div>

<!-- åº•éƒ¨æäº¤æ  -->
<div class="bottom-bar">
  <div class="bottom-summary">
    <span id="filledCount">å·²å¡«: 0 / 0</span>
    <span class="draft-label" id="draftLabel">ğŸ“ è‰ç¨¿å·²ä¿å­˜</span>
  </div>
  <button class="submit-btn" id="submitBtn" onclick="confirmSubmit()" disabled>
    æäº¤ç›˜ç‚¹è®°å½•
  </button>
</div>

<!-- å¼¹çª— -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal-box" id="modalBox"></div>
</div>

<!-- æ·»åŠ ç‰©å“ FAB -->
<button class="add-item-fab" id="addItemFab" onclick="openAddItemModal()">ï¼‹</button>

<!-- æ·»åŠ ç‰©å“ Sheet Modal -->
<div class="add-item-overlay" id="addItemOverlay" onclick="closeAddItemOverlayBg(event)">
  <div class="add-item-sheet">
    <div class="ai-handle"></div>
    <div class="ai-title">â• æ–°å¢ç‰©å“</div>

    <!-- å›¾ç‰‡åŒº -->
    <div class="ai-photo-area" id="aiPhotoArea" onclick="triggerPhotoInput()">
      <img id="aiPhotoPreview" style="display:none">
      <div class="ai-photo-placeholder" id="aiPhotoPlaceholder">
        <div style="font-size:28px">ğŸ“·</div>
        <div>æ‹ç…§ / é€‰å›¾ï¼ˆå¯é€‰ï¼‰</div>
      </div>
    </div>
    <input type="file" id="aiPhotoInput" accept="image/*" capture="environment"
           style="display:none" onchange="onPhotoSelected(this)">

    <!-- ç‰©å“åç§° -->
    <label class="ai-label">ç‰©å“åç§° <span style="color:#d32f2f">*</span></label>
    <input id="ai_name" class="ai-input" type="text" placeholder="ä¾‹ï¼šäº”èŠ±è‚‰">

    <!-- ç±»åˆ« -->
    <label class="ai-label">ç±»åˆ« <span style="color:#d32f2f">*</span></label>
    <select id="ai_cat" class="ai-input"></select>

    <!-- è®¡é‡å•ä½ -->
    <label class="ai-label">è®¡é‡å•ä½ <span style="color:#d32f2f">*</span></label>
    <select id="ai_unit" class="ai-input" onchange="onUnitChange(this)">
      <option value="kg">kgï¼ˆå…¬æ–¤ï¼‰</option>
      <option value="g">gï¼ˆå…‹ï¼‰</option>
      <option value="åŒ…">åŒ…</option>
      <option value="ç›’">ç›’</option>
      <option value="ç“¶">ç“¶</option>
      <option value="æ¡¶">æ¡¶</option>
      <option value="ç®±">ç®±</option>
      <option value="è¢‹">è¢‹</option>
      <option value="ä»½">ä»½</option>
      <option value="æ¡">æ¡</option>
      <option value="ç½">ç½</option>
      <option value="å‡">å‡ï¼ˆLï¼‰</option>
      <option value="æ¯«å‡">æ¯«å‡ï¼ˆmLï¼‰</option>
      <option value="ä¸ª">ä¸ª</option>
      <option value="ç‰‡">ç‰‡</option>
    </select>

    <!-- æ¯åŒ…ä»¶æ•°ï¼ˆä»…å½“é€‰åŒ…è£…å•ä½æ—¶æ˜¾ç¤ºï¼‰ -->
    <div id="aiPkgRow" style="display:none">
      <label class="ai-label">æ¯åŒ…ä»¶æ•° <span style="color:#d32f2f">*</span></label>
      <input id="ai_pkg_qty" class="ai-input" type="number" min="1" placeholder="ä¾‹ï¼š10">
    </div>

    <button id="addItemSaveBtn" class="ai-save-btn" onclick="saveNewItem()">+ æ·»åŠ ç‰©å“</button>
    <button class="ai-cancel-btn" onclick="closeAddItemOverlayDirect()">å–æ¶ˆ</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Storage è¾…åŠ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ssGet(k)    { try { return sessionStorage.getItem(k); }     catch(e){ return null; } }
function ssSet(k, v) { try { sessionStorage.setItem(k, v); }         catch(e){} }
function ssRemove(k) { try { sessionStorage.removeItem(k); }         catch(e){} }
function ssClearPfx(pfx) {
  try {
    Object.keys(sessionStorage)
      .filter(function(k){ return k.indexOf(pfx) === 0; })
      .forEach(function(k){ sessionStorage.removeItem(k); });
  } catch(e) {}
}
function lsGet(k)  { try { return localStorage.getItem(k);  } catch(e){ return null; } }
function lsDel(k)  { try { localStorage.removeItem(k);      } catch(e){} }

// â”€â”€ é¡µé¢æƒé™è¾…åŠ© â”€â”€
var ROLE_DEFAULT_PERMS = {
  'Boss':    { pages: ['check','dashboard','admin'], adminTabs: [0,1,2,3,4] },
  'Manager': { pages: ['dashboard','admin'],         adminTabs: [0,1,2,3]   },
  'Staff':   { pages: ['check'],                     adminTabs: []           }
};
function parsePermissions(permStr, role) {
  try { var p = JSON.parse(permStr); if (p && Array.isArray(p.pages)) return p; } catch(e) {}
  return ROLE_DEFAULT_PERMS[role] || { pages: ['check'], adminTabs: [] };
}
function navigateTo(page) {
  google.script.run.withSuccessHandler(function(url) {
    var a = document.createElement('a');
    a.href = url + '?page=' + page;
    a.target = '_top';
    document.body.appendChild(a);
    a.click();
  }).getAppUrl();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å…¨å±€çŠ¶æ€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var currentUser  = null;
var allItems     = [];
var currentCat   = 'å…¨éƒ¨';
var DRAFT_PFX    = 'ckd_';   // check-draft prefix

// â”€â”€ Toast æç¤º â”€â”€
function showToast(msg, duration) {
  var el = document.createElement('div');
  el.className = 'ims-toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(function() {
    el.style.transition = 'opacity .3s';
    el.style.opacity = '0';
    setTimeout(function() { el.parentNode && el.parentNode.removeChild(el); }, 350);
  }, duration || 2500);
}

// â”€â”€ æ·»åŠ ç‰©å“ â”€â”€
var pendingPhotoBase64 = null;
var pendingPhotoMime   = null;
var pendingPhotoName   = null;

var PKG_UNITS = ['åŒ…','ç›’','ç®±','è¢‹'];
function onUnitChange(sel) {
  var show = PKG_UNITS.indexOf(sel.value) >= 0;
  document.getElementById('aiPkgRow').style.display = show ? '' : 'none';
  if (!show) document.getElementById('ai_pkg_qty').value = '';
}

function openAddItemModal() {
  // é‡ç½®è¡¨å•
  pendingPhotoBase64 = null; pendingPhotoMime = null; pendingPhotoName = null;
  document.getElementById('aiPhotoPreview').style.display    = 'none';
  document.getElementById('aiPhotoPreview').src              = '';
  document.getElementById('aiPhotoPlaceholder').style.display = 'flex';
  document.getElementById('aiPhotoInput').value              = '';
  document.getElementById('ai_name').value                   = '';
  document.getElementById('ai_unit').selectedIndex           = 0;
  document.getElementById('aiPkgRow').style.display          = 'none';
  document.getElementById('ai_pkg_qty').value                = '';

  // å¡«å……ç±»åˆ« selectï¼ˆä¼˜å…ˆä»å·²æœ‰ç‰©å“æå–ï¼‰
  var catSel = document.getElementById('ai_cat');
  catSel.innerHTML = '';
  var defaultCats = [
    'è‚‰ç±»','èœç±»','æµ·é²œ','è°ƒæ–™','é¥®æ–™','ä¸»é£Ÿ',
    'è˜¸æ–™','æ²¹æ–™','å†·å†»','å¹²è´§','ä¸¸å­','é”…åº•',
    'ç”œå“','é…’æ°´','å°åƒ','æ¶ˆè€—å“','é¤å…·','å…¶ä»–'
  ];
  // åˆå¹¶é»˜è®¤åˆ†ç±» + å·²æœ‰ç‰©å“åˆ†ç±»ï¼ˆç¡®ä¿æ‰€æœ‰é»˜è®¤ç±»åˆ«å§‹ç»ˆæ˜¾ç¤ºï¼‰
  var merged = {};
  defaultCats.forEach(function(c){ merged[c] = 1; });
  allItems.forEach(function(it){ if (it.category) merged[it.category] = 1; });
  var catList = Object.keys(merged).sort(function(a, b) {
    var ia = defaultCats.indexOf(a), ib = defaultCats.indexOf(b);
    if (ia >= 0 && ib >= 0) return ia - ib;
    if (ia >= 0) return -1;
    if (ib >= 0) return  1;
    return a.localeCompare(b);
  });
  catList.forEach(function(c) {
    var opt = document.createElement('option');
    opt.value = c; opt.textContent = c;
    catSel.appendChild(opt);
  });

  // é‡ç½®æŒ‰é’®
  var btn = document.getElementById('addItemSaveBtn');
  btn.disabled = false; btn.textContent = '+ æ·»åŠ ç‰©å“';

  document.getElementById('addItemOverlay').classList.add('show');
}

function triggerPhotoInput() {
  document.getElementById('aiPhotoInput').click();
}

function onPhotoSelected(input) {
  var file = input.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    var img = new Image();
    img.onload = function() {
      var canvas = document.createElement('canvas');
      var MAX = 800, w = img.width, h = img.height;
      if (w > MAX || h > MAX) {
        if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
        else       { w = Math.round(w * MAX / h); h = MAX; }
      }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      var compressed = canvas.toDataURL('image/jpeg', 0.7);
      pendingPhotoBase64 = compressed.split(',')[1];
      pendingPhotoMime   = 'image/jpeg';
      pendingPhotoName   = 'item_' + Date.now() + '.jpg';
      var preview = document.getElementById('aiPhotoPreview');
      preview.src = compressed;
      preview.style.display = 'block';
      document.getElementById('aiPhotoPlaceholder').style.display = 'none';
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function saveNewItem() {
  var name     = document.getElementById('ai_name').value.trim();
  var cat      = document.getElementById('ai_cat').value;
  var unitBase = document.getElementById('ai_unit').value;
  var pkgQty   = document.getElementById('ai_pkg_qty').value.trim();
  if (!name) { showToast('âŒ ç‰©å“åç§°ä¸èƒ½ä¸ºç©º'); return; }
  var unit = unitBase;
  if (PKG_UNITS.indexOf(unitBase) >= 0) {
    if (!pkgQty || Number(pkgQty) < 1) { showToast('âŒ è¯·å¡«å†™æ¯åŒ…ä»¶æ•°'); return; }
    unit = unitBase + '(' + pkgQty + 'ä»¶)';
  }

  var btn = document.getElementById('addItemSaveBtn');
  btn.disabled = true; btn.textContent = 'â³ ä¿å­˜ä¸­...';

  function doCreate(imageUrl) {
    google.script.run
      .withSuccessHandler(function(resp) {
        btn.disabled = false; btn.textContent = '+ æ·»åŠ ç‰©å“';
        if (resp && resp.success) {
          document.getElementById('addItemOverlay').classList.remove('show');
          showToast('âœ… ç‰©å“å·²æ·»åŠ : ' + name);
        } else {
          showToast('âŒ ' + (resp ? resp.error : 'æ·»åŠ å¤±è´¥'));
        }
      })
      .withFailureHandler(function(err) {
        btn.disabled = false; btn.textContent = '+ æ·»åŠ ç‰©å“';
        showToast('âŒ ' + (err.message || err));
      })
      .createItem(currentUser.username, { name: name, category: cat, unit: unit, imageUrl: imageUrl || '' });
  }

  if (pendingPhotoBase64) {
    google.script.run
      .withSuccessHandler(function(resp) {
        if (resp && resp.success) {
          doCreate(resp.url);
        } else {
          showToast('âš ï¸ å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œç‰©å“ä»å°†ä¿å­˜ï¼ˆæ— å›¾ï¼‰');
          doCreate('');
        }
      })
      .withFailureHandler(function() { doCreate(''); })
      .uploadItemPhoto(currentUser.username, pendingPhotoBase64, pendingPhotoMime, pendingPhotoName);
  } else {
    doCreate('');
  }
}

function closeAddItemOverlayBg(evt) {
  if (evt.target === document.getElementById('addItemOverlay')) {
    closeAddItemOverlayDirect();
  }
}
function closeAddItemOverlayDirect() {
  document.getElementById('addItemOverlay').classList.remove('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åˆå§‹åŒ–
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load', function() {
  var stored = ssGet('ims_user') || lsGet('ims_user');
  if (!stored) { goLogin(); return; }
  try { currentUser = JSON.parse(stored); } catch(e) { goLogin(); return; }

  // é¡µé¢æƒé™æ£€æŸ¥
  var myPerms = parsePermissions(currentUser.permissions, currentUser.role);
  if (myPerms.pages.indexOf('check') < 0) {
    if (myPerms.pages.indexOf('dashboard') >= 0) { navigateTo('dashboard'); return; }
    if (myPerms.pages.indexOf('admin') >= 0)     { navigateTo('admin');     return; }
    goLogin(); return;
  }

  document.getElementById('staffLabel').textContent =
    'ğŸ‘¤ ' + (currentUser.name || currentUser.username);

  // æ˜¾ç¤ºã€Œ+ ç‰©å“ã€æŒ‰é’®ï¼ˆä»… Manager/Bossï¼‰
  if (currentUser.role === 'Manager' || currentUser.role === 'Boss') {
    document.getElementById('addItemFab').style.display    = 'flex';
    document.getElementById('addItemTopBtn').style.display = '';
  }

  loadItems();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åŠ è½½ç‰©å“
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadItems() {
  showLoading('æ­£åœ¨åŠ è½½ç›˜ç‚¹ç‰©å“...');
  google.script.run
    .withSuccessHandler(onItemsLoaded)
    .withFailureHandler(function(err) {
      showError('åŠ è½½å¤±è´¥ï¼š' + (err.message || err));
    })
    .getTodayCheckItems(currentUser.username);
}

function onItemsLoaded(resp) {
  if (!resp || !resp.success) {
    showError(resp ? resp.error : 'æœåŠ¡å™¨æ— å“åº”');
    return;
  }
  allItems = resp.items || [];
  if (allItems.length === 0) {
    showEmpty('ä»Šæ—¥æš‚æ— åˆ†é…ç»™æ‚¨çš„ç›˜ç‚¹ä»»åŠ¡');
    updateProgress(0, 0);
    return;
  }
  buildCatTabs();
  renderItems(currentCat);
  restoreDrafts();
  updateFilledCount();
  updateProgress(-1, -1);   // auto-calc
  document.getElementById('statusArea').style.display = 'none';
  document.getElementById('itemsList').style.display  = 'block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// çŠ¶æ€æ˜¾ç¤º
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLoading(msg) {
  var el = document.getElementById('statusArea');
  el.style.display = 'block';
  document.getElementById('itemsList').style.display = 'none';
  el.innerHTML = '<div class="spinner"></div><div>' + msg + '</div>';
}
function showError(msg) {
  var el = document.getElementById('statusArea');
  el.style.display = 'block';
  document.getElementById('itemsList').style.display = 'none';
  el.innerHTML = '<div style="font-size:36px;margin-bottom:12px">âŒ</div>' +
    '<div style="color:#d32f2f;margin-bottom:16px">' + msg + '</div>' +
    '<button onclick="loadItems()" style="padding:9px 20px;background:#d32f2f;color:#fff;' +
    'border:none;border-radius:8px;font-size:14px;cursor:pointer">é‡è¯•</button>';
}
function showEmpty(msg) {
  var el = document.getElementById('statusArea');
  el.style.display = 'block';
  document.getElementById('itemsList').style.display = 'none';
  el.innerHTML = '<div class="empty-state"><div class="icon">âœ…</div><div>' + msg + '</div></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åˆ†ç±» Tab
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildCatTabs() {
  var cats = ['å…¨éƒ¨'];
  allItems.forEach(function(it) {
    if (it.category && cats.indexOf(it.category) < 0) cats.push(it.category);
  });
  var wrap = document.getElementById('catTabs');
  wrap.innerHTML = '';
  cats.forEach(function(cat) {
    var cnt = cat === 'å…¨éƒ¨' ? allItems.length :
      allItems.filter(function(i){ return i.category === cat; }).length;
    var div = document.createElement('div');
    div.className = 'cat-tab' + (cat === currentCat ? ' active' : '');
    div.textContent = cat + ' (' + cnt + ')';
    div.onclick = (function(c){ return function(){ switchCat(c); }; })(cat);
    wrap.appendChild(div);
  });
}

function switchCat(cat) {
  currentCat = cat;
  document.querySelectorAll('.cat-tab').forEach(function(el) {
    el.classList.toggle('active', el.textContent.indexOf(cat + ' ') === 0);
  });
  renderItems(cat);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ¸²æŸ“ç‰©å“
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var CAT_EMOJI = {
  'è‚‰ç±»':'ğŸ¥©','èœç±»':'ğŸ¥¬','æµ·é²œ':'ğŸ¦','è°ƒæ–™':'ğŸ§‚','é¥®æ–™':'ğŸ§ƒ',
  'ä¸»é£Ÿ':'ğŸš','è˜¸æ–™':'ğŸ²','æ²¹æ–™':'ğŸ«™','å†·å†»':'â„ï¸','å¹²è´§':'ğŸŒ¾',
  'ä¸¸å­':'ğŸœ','é”…åº•':'ğŸ«•','æ¶ˆè€—å“':'ğŸ§»',
  'ç”œå“':'ğŸ®','é…’æ°´':'ğŸº','å°åƒ':'ğŸ¥Ÿ','é¤å…·':'ğŸ¥„','å…¶ä»–':'ğŸ“¦'
};
function catEmoji(cat) { return CAT_EMOJI[cat] || 'ğŸ“¦'; }

function renderItems(cat) {
  var list = cat === 'å…¨éƒ¨' ? allItems :
    allItems.filter(function(i){ return i.category === cat; });
  var container = document.getElementById('itemsList');
  container.innerHTML = '';
  if (!list.length) {
    container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div>' +
      '<div>è¯¥åˆ†ç±»æš‚æ— ç‰©å“</div></div>';
    return;
  }
  list.forEach(function(item) { container.appendChild(makeCard(item)); });
}

function makeCard(item) {
  var cur = Number(item.currentQty) || 0;
  var min = Number(item.minStock)   || 0;
  var max = Number(item.maxStock)   || 0;

  // è‚¡ç¥¨çŠ¶æ€
  var sClass = cur < min ? 'stock-low' : (max > 0 && cur > max ? 'stock-high' : 'stock-ok');
  var sLabel = min > 0 ? ' Â· æœ€ä½:' + min : '';
  if (max > 0) sLabel += ' æœ€é«˜:' + max;

  // å¡ç‰‡
  var card = document.createElement('div');
  card.className = 'item-card';
  card.id = 'card_' + item.id;

  // å›¾ç‰‡
  var photoDiv = document.createElement('div');
  photoDiv.className = 'item-photo';
  if (item.imageUrl && item.imageUrl.match(/^https?:\/\//)) {
    var img = document.createElement('img');
    img.src = item.imageUrl;
    img.alt = item.name;
    img.onerror = function() { photoDiv.textContent = catEmoji(item.category); };
    photoDiv.appendChild(img);
  } else {
    photoDiv.textContent = catEmoji(item.category);
  }

  // ä¿¡æ¯
  var infoDiv = document.createElement('div');
  infoDiv.className = 'item-info';
  infoDiv.innerHTML =
    '<div class="item-name">' + escHtml(item.name) + '</div>' +
    '<div class="item-meta">' + escHtml(item.category || '') +
      (item.supplier ? ' Â· ' + escHtml(item.supplier) : '') + '</div>' +
    '<div class="item-stock">ç°æœ‰: <span class="' + sClass + '">' + cur + '</span> ' +
      escHtml(item.unit || '') + sLabel + '</div>';

  // è¾“å…¥
  var wrapDiv = document.createElement('div');
  wrapDiv.className = 'item-input-wrap';

  var qtyRow = document.createElement('div');
  qtyRow.className = 'qty-row';

  var input = document.createElement('input');
  input.type = 'number';
  input.className = 'qty-input';
  input.id = 'inp_' + item.id;
  input.min = '0'; input.step = '1';
  input.placeholder = '--';
  input.addEventListener('input', (function(it){ return function(){ onInput(it, this); }; })(item));
  input.addEventListener('focus', function(){ this.select(); });

  var unitSpan = document.createElement('span');
  unitSpan.className = 'qty-unit';
  unitSpan.textContent = item.unit || '';

  var diffDiv = document.createElement('div');
  diffDiv.className = 'qty-diff';
  diffDiv.id = 'diff_' + item.id;

  qtyRow.appendChild(input);
  qtyRow.appendChild(unitSpan);
  wrapDiv.appendChild(qtyRow);
  wrapDiv.appendChild(diffDiv);

  card.appendChild(photoDiv);
  card.appendChild(infoDiv);
  card.appendChild(wrapDiv);
  return card;
}

function escHtml(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// è¾“å…¥ & è‰ç¨¿
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onInput(item, el) {
  var val = el.value.trim();
  var diffEl = document.getElementById('diff_' + item.id);
  var card   = document.getElementById('card_' + item.id);

  if (val === '' || isNaN(Number(val))) {
    diffEl.textContent = '';
    el.classList.remove('filled');
    card.classList.remove('has-input');
    ssRemove(DRAFT_PFX + item.id);
  } else {
    var qty  = Number(val);
    var diff = qty - (Number(item.currentQty) || 0);
    diffEl.textContent = diff > 0 ? '+' + diff : (diff < 0 ? '' + diff : 'Â±0');
    diffEl.className   = 'qty-diff ' +
      (diff > 0 ? 'diff-pos' : diff < 0 ? 'diff-neg' : 'diff-zero');
    el.classList.add('filled');
    card.classList.add('has-input');
    ssSet(DRAFT_PFX + item.id, val);
    document.getElementById('draftLabel').style.display = 'inline';
  }
  updateFilledCount();
  updateProgress(-1, -1);
}

function restoreDrafts() {
  var any = false;
  allItems.forEach(function(item) {
    var saved = ssGet(DRAFT_PFX + item.id);
    if (saved !== null && saved !== '') {
      var el = document.getElementById('inp_' + item.id);
      if (el) { el.value = saved; onInput(item, el); any = true; }
    }
  });
  if (any) document.getElementById('draftLabel').style.display = 'inline';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç»Ÿè®¡
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function countFilled() {
  var n = 0;
  allItems.forEach(function(it) {
    var el = document.getElementById('inp_' + it.id);
    if (el && el.value.trim() !== '' && !isNaN(Number(el.value))) n++;
  });
  return n;
}

function updateFilledCount() {
  var total  = allItems.length;
  var filled = countFilled();
  document.getElementById('filledCount').textContent =
    'å·²å¡«: ' + filled + ' / ' + total;
  var btn = document.getElementById('submitBtn');
  btn.disabled = (filled === 0);
  if (filled > 0 && filled < total) {
    btn.textContent = 'æäº¤ç›˜ç‚¹ (' + filled + '/' + total + ')';
  } else if (filled === total && total > 0) {
    btn.textContent = 'âœ… å…¨éƒ¨å¡«å®Œï¼Œæäº¤ (' + total + ')';
  } else {
    btn.textContent = 'æäº¤ç›˜ç‚¹è®°å½•';
  }
}

function updateProgress(done, total) {
  if (done < 0) { done = countFilled(); total = allItems.length; }
  var pct = total > 0 ? Math.round(done / total * 100) : 0;
  document.getElementById('progressText').textContent =
    'ç›˜ç‚¹è¿›åº¦ï¼š' + done + ' / ' + total + ' ä»¶';
  document.getElementById('progressPct').textContent  = pct + '%';
  document.getElementById('progressFill').style.width = pct + '%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æäº¤
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function confirmSubmit() {
  var items = collectItems();
  if (!items.length) { alert('è¯·è‡³å°‘å¡«å†™ä¸€ä»¶ç‰©å“çš„æ•°é‡'); return; }
  var missing = allItems.length - items.length;
  var msg = 'å·²å¡«å†™ <b>' + items.length + '</b> ä»¶ç‰©å“ã€‚';
  if (missing > 0) msg += '<br>å¦æœ‰ <b>' + missing + '</b> ä»¶æœªå¡«å†™ï¼Œå°†è·³è¿‡ã€‚';
  msg += '<br><br>ç¡®è®¤æäº¤æœ¬æ¬¡ç›˜ç‚¹ï¼Ÿ';
  showModal('ğŸ“‹', 'ç¡®è®¤æäº¤', msg, [
    { label: 'ç¡®è®¤æäº¤', primary: true,  fn: doSubmit },
    { label: 'ç»§ç»­ç›˜ç‚¹', primary: false, fn: closeModal }
  ]);
}

function collectItems() {
  var arr = [];
  allItems.forEach(function(it) {
    var el = document.getElementById('inp_' + it.id);
    if (el && el.value.trim() !== '' && !isNaN(Number(el.value))) {
      arr.push({
        itemId: it.id, name: it.name, category: it.category, unit: it.unit,
        newQty: Number(el.value),
        prevQty: Number(it.currentQty) || 0
      });
    }
  });
  return arr;
}

function doSubmit() {
  closeModal();
  var items = collectItems();
  var btn = document.getElementById('submitBtn');
  btn.disabled = true;
  btn.textContent = 'â³ æäº¤ä¸­...';

  google.script.run
    .withSuccessHandler(onSubmitDone)
    .withFailureHandler(function(err) {
      btn.disabled = false;
      updateFilledCount();
      showModal('âŒ', 'æäº¤å¤±è´¥',
        'é”™è¯¯ï¼š' + (err.message || err) + '<br>è¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚', [
        { label: 'é‡è¯•', primary: true,  fn: confirmSubmit },
        { label: 'å–æ¶ˆ', primary: false, fn: closeModal }
      ]);
    })
    .submitCheckRecord(currentUser.name || currentUser.username, items);
}

function onSubmitDone(resp) {
  if (!resp || !resp.success) {
    document.getElementById('submitBtn').disabled = false;
    updateFilledCount();
    showModal('âŒ', 'æäº¤å¤±è´¥', resp ? resp.error : 'æœåŠ¡å™¨æ— å“åº”', [
      { label: 'é‡è¯•', primary: true,  fn: confirmSubmit },
      { label: 'å–æ¶ˆ', primary: false, fn: closeModal }
    ]);
    return;
  }

  // æ¸…è‰ç¨¿
  ssClearPfx(DRAFT_PFX);
  document.getElementById('draftLabel').style.display = 'none';

  var saved   = resp.saved   || 0;
  var abnormals = resp.abnormals || [];

  if (abnormals.length > 0) {
    var box = document.getElementById('modalBox');
    var rows = abnormals.map(function(a) {
      return '<div class="abnormal-item">âš ï¸ <b>' +
        escHtml(a.name) + '</b>: ' + a.qty + (a.unit||'') +
        ' (' + escHtml(a.reason) + ')</div>';
    }).join('');
    box.innerHTML =
      '<div class="success-anim">âœ…</div>' +
      '<div class="modal-title" style="margin-bottom:8px">æäº¤æˆåŠŸï¼</div>' +
      '<div class="modal-msg">å·²è®°å½• <b>' + saved + '</b> ä»¶ç‰©å“ã€‚</div>' +
      '<div style="font-size:13px;color:#e65100;font-weight:600;margin-bottom:6px">' +
        'âš ï¸ ä»¥ä¸‹ç‰©å“åº“å­˜å¼‚å¸¸ï¼Œå·²æé†’ç®¡ç†å‘˜ï¼š</div>' +
      '<div class="abnormal-list">' + rows + '</div>' +
      '<button class="modal-btn modal-btn-primary" onclick="goLogin()">å®Œæˆ</button>';
    document.getElementById('modalOverlay').classList.add('show');
  } else {
    showModal('', 'æäº¤æˆåŠŸï¼',
      'å·²è®°å½• <b>' + saved + '</b> ä»¶ç›˜ç‚¹ç‰©å“ã€‚ä»Šæ—¥ä»»åŠ¡å®Œæˆï¼', [
      { label: 'å®Œæˆ', primary: true, fn: goLogin }
    ], 'ğŸ‰');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å¼¹çª—
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showModal(icon, title, msg, btns, overrideIcon) {
  var box = document.getElementById('modalBox');
  var useIcon = overrideIcon || icon;
  var html = '';
  if (useIcon) html += '<div class="modal-icon">' + useIcon + '</div>';
  html += '<div class="modal-title">' + title + '</div>';
  if (msg) html += '<div class="modal-msg">' + msg + '</div>';
  btns.forEach(function(b, i) {
    html += '<button class="modal-btn ' +
      (b.primary ? 'modal-btn-primary' : 'modal-btn-secondary') +
      '" id="mbtn' + i + '">' + b.label + '</button>';
  });
  box.innerHTML = html;
  btns.forEach(function(b, i) {
    document.getElementById('mbtn' + i).onclick = b.fn;
  });
  document.getElementById('modalOverlay').classList.add('show');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å¯¼èˆª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goLogin() {
  google.script.run.withSuccessHandler(function(url) {
    var a = document.createElement('a');
    a.href = url + '?page=login';
    a.target = '_top';
    document.body.appendChild(a);
    a.click();
  }).getAppUrl();
}

function doLogout() {
  var hasDraft = false;
  try {
    var keys = Object.keys(sessionStorage);
    for (var i = 0; i < keys.length; i++) {
      if (keys[i].indexOf(DRAFT_PFX) === 0) { hasDraft = true; break; }
    }
  } catch(e) {}

  if (hasDraft) {
    showModal('âš ï¸', 'ç¡®è®¤é€€å‡ºï¼Ÿ',
      'æ‚¨æœ‰æœªæäº¤çš„è‰ç¨¿æ•°æ®ã€‚<br>é€€å‡ºåè‰ç¨¿å°†ä¿ç•™ï¼Œä¸‹æ¬¡è¿›å…¥æ­¤é¡µé¢ä»å¯ç»§ç»­ã€‚', [
      { label: 'é€€å‡ºç™»å½•', primary: false, fn: _doLogout },
      { label: 'ç»§ç»­ç›˜ç‚¹', primary: true,  fn: closeModal }
    ]);
  } else {
    _doLogout();
  }
}

function _doLogout() {
  closeModal();
  lsDel('ims_user');
  ssRemove('ims_user');
  goLogin();
}
</script>
</body>
</html>
